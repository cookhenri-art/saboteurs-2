<!DOCTYPE html>
<html lang="fr" data-theme="default">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé® Cr√©er mon Avatar IA - Saboteur</title>
  <link rel="stylesheet" href="auth-themes.css">
  
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 80px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header h1 {
      font-family: var(--font-title);
      color: var(--neon-main);
      font-size: clamp(1.5rem, 4vw, 2rem);
      text-shadow: 0 0 15px var(--neon-main);
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: linear-gradient(135deg, rgba(10, 14, 26, 0.95) 0%, rgba(26, 31, 53, 0.9) 100%);
      border: 2px solid var(--metal-grey);
      border-radius: calc(var(--border-radius) + 10px);
      padding: 25px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    }

    .card-title {
      font-family: var(--font-title);
      color: var(--neon-main);
      font-size: 1.1rem;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }

    /* Upload Zone */
    .upload-zone {
      border: 3px dashed var(--metal-grey);
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(0, 0, 0, 0.3);
    }

    .upload-zone:hover {
      border-color: var(--neon-main);
      background: rgba(0, 0, 0, 0.4);
    }

    .upload-zone.has-photo { padding: 10px; }
    .upload-zone .icon { font-size: 3rem; margin-bottom: 15px; }
    .upload-zone p { color: var(--text-secondary); }

    .upload-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: var(--border-radius);
      display: none;
    }

    /* Theme Selector */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .theme-btn {
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid var(--metal-grey);
      border-radius: var(--border-radius);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-family: var(--font-body);
    }

    .theme-btn:hover {
      border-color: var(--neon-main);
      color: var(--text-primary);
    }

    .theme-btn.active {
      border-color: var(--neon-main);
      background: rgba(0, 255, 255, 0.1);
      color: var(--neon-main);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    .theme-btn.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .theme-btn .icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
    .theme-btn .name { font-size: 0.85rem; }
    .theme-btn .lock { font-size: 0.7rem; color: var(--neon-orange); }

    /* Character Selector */
    .character-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .character-btn {
      padding: 12px 8px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid var(--metal-grey);
      border-radius: var(--border-radius);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.8rem;
      text-align: center;
      font-family: var(--font-body);
    }

    .character-btn:hover {
      border-color: var(--neon-purple);
      color: var(--text-primary);
    }

    .character-btn.active {
      border-color: var(--neon-purple);
      background: rgba(157, 78, 221, 0.15);
      color: var(--neon-purple);
    }

    /* Admin Sliders Section */
    .admin-section {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: var(--border-radius);
    }

    .admin-section.show {
      display: block;
    }

    .admin-section h4 {
      color: #ff6b6b;
      margin-bottom: 15px;
      font-family: var(--font-title);
    }

    .slider-group {
      margin-bottom: 20px;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .slider-header label {
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    .slider-value {
      background: rgba(255, 107, 107, 0.3);
      padding: 4px 10px;
      border-radius: 5px;
      font-weight: bold;
      color: #ff6b6b;
      min-width: 40px;
      text-align: center;
    }

    .slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      cursor: pointer;
      border: none;
    }

    .slider-hints {
      display: flex;
      justify-content: space-between;
      font-size: 0.75em;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* Presets */
    .presets-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .preset-btn {
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--metal-grey);
      border-radius: var(--border-radius);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.3s;
    }

    .preset-btn:hover {
      border-color: var(--neon-main);
      color: var(--neon-main);
    }

    /* Custom Prompt */
    .custom-prompt-section {
      display: none;
      margin-top: 20px;
    }

    .custom-prompt-section.show {
      display: block;
    }

    .custom-prompt-section textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--border-radius);
      border: 2px solid var(--metal-grey);
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-primary);
      resize: vertical;
      min-height: 80px;
      font-family: var(--font-body);
    }

    .custom-prompt-section textarea:focus {
      outline: none;
      border-color: var(--neon-purple);
    }

    /* Result */
    .result-zone {
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--metal-grey);
      border-radius: var(--border-radius);
      background: rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .result-placeholder {
      text-align: center;
      color: var(--text-muted);
    }

    .result-placeholder .icon { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }

    .result-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: var(--border-radius);
      display: none;
    }

    /* Progress */
    .progress-bar {
      height: 6px;
      background: var(--metal-grey);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar.show {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-main), var(--neon-purple));
      border-radius: 3px;
      animation: progress 3s ease-in-out infinite;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* Stats */
    .stats {
      display: flex;
      justify-content: space-around;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      margin-top: 20px;
    }

    .stat { text-align: center; }
    .stat-value { font-family: var(--font-title); font-size: 1.5rem; color: var(--neon-main); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); }

    /* Generate Button */
    .generate-btn {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      margin-top: 20px;
    }

    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .gallery-item {
      aspect-ratio: 1;
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 2px solid var(--metal-grey);
      cursor: pointer;
      transition: all 0.3s;
    }

    .gallery-item:hover {
      border-color: var(--neon-main);
      transform: scale(1.05);
    }

    .gallery-item.active {
      border-color: var(--neon-green);
      box-shadow: 0 0 15px var(--neon-green);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Bouton suppression avatar */
    .gallery-item {
      position: relative;
    }

    .delete-avatar-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 0, 85, 0.9);
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .gallery-item:hover .delete-avatar-btn {
      opacity: 1;
    }

    .delete-avatar-btn:hover {
      background: var(--neon-red);
      transform: scale(1.1);
    }

    /* Avatar cass√©/manquant */
    .gallery-item.broken {
      background: rgba(255, 0, 85, 0.2);
      border-color: var(--neon-red);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gallery-item.broken::after {
      content: '‚ùå';
      font-size: 2rem;
    }

    .gallery-item.broken .delete-avatar-btn {
      opacity: 1;
    }

    /* Download */
    .download-btn {
      position: absolute;
      bottom: 15px;
      right: 15px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--neon-green);
      border-radius: var(--border-radius);
      color: var(--neon-green);
      cursor: pointer;
      display: none;
      font-family: var(--font-body);
    }

    .download-btn.show {
      display: block;
    }

    .download-btn:hover {
      background: var(--neon-green);
      color: var(--primary-bg);
    }

    /* Error banner */
    .error-banner {
      display: none;
      background: linear-gradient(135deg, rgba(255, 0, 85, 0.2) 0%, rgba(255, 107, 53, 0.2) 100%);
      border: 1px solid var(--neon-red);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      color: var(--neon-red);
      text-align: center;
    }

    .error-banner.show {
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--neon-green);
      color: var(--primary-bg);
      padding: 15px 25px;
      border-radius: var(--border-radius);
      display: none;
      z-index: 1001;
      font-weight: 600;
    }

    .toast.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    .toast.error {
      background: var(--neon-red);
      color: white;
    }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- S√©lecteur de th√®me -->
  <div class="theme-selector-mini">
    <button class="theme-btn-mini active" data-theme="default" title="Spatial">üöÄ</button>
    <button class="theme-btn-mini" data-theme="werewolf" title="Loup-Garou">üê∫</button>
    <button class="theme-btn-mini" data-theme="wizard-academy" title="Sorciers">üßô</button>
    <button class="theme-btn-mini" data-theme="mythic-realms" title="Mythique">‚öîÔ∏è</button>
  </div>

  <div class="container">
    <header class="header">
      <h1>üé® CR√âER MON AVATAR IA</h1>
      <div class="header-buttons">
        <a href="/" class="btn btn-secondary">üè† Accueil</a>
        <a href="/game.html" class="btn btn-primary">üéÆ Jouer</a>
      </div>
    </header>

    <!-- Error Banner -->
    <div class="error-banner" id="errorBanner"></div>

    <div class="main-grid">
      <!-- Controls -->
      <div class="card">
        <h2 class="card-title">üì∏ TA PHOTO</h2>
        
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('photoInput').click()">
          <div class="icon">üì∑</div>
          <p>Clique pour ajouter ta photo</p>
          <p style="font-size: 0.8rem; margin-top: 10px; color: var(--text-muted);">Selfie de face recommand√©</p>
          <img class="upload-preview" id="uploadPreview">
        </div>
        <input type="file" id="photoInput" accept="image/*" style="display: none">

        <h2 class="card-title" style="margin-top: 25px;">üé® TH√àME DE L'AVATAR</h2>
        <div class="theme-grid" id="avatarThemeGrid"></div>

        <h2 class="card-title">üë§ PERSONNAGE</h2>
        <div class="character-grid" id="characterGrid"></div>

        <!-- Custom Prompt (Premium/Admin) -->
        <div class="custom-prompt-section" id="customPromptSection">
          <h2 class="card-title">‚ú® PROMPT PERSONNALIS√â</h2>
          <textarea id="customPrompt" placeholder="D√©cris ton personnage personnalis√©..."></textarea>
        </div>

        <!-- Admin Sliders -->
        <div class="admin-section" id="adminSection">
          <h4>üîß Param√®tres avanc√©s (Admin)</h4>
          
          <!-- Slider 1: Ressemblance -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üë§ Ressemblance au visage</label>
              <span class="slider-value" id="sliderValue1">5</span>
            </div>
            <input type="range" min="0" max="10" value="5" class="slider" id="slider1" oninput="updateSliderValue(1)">
            <div class="slider-hints">
              <span>Stylis√©</span>
              <span>Fid√®le</span>
            </div>
          </div>

          <!-- Slider 2: Force du style -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üé® Force du style/prompt</label>
              <span class="slider-value" id="sliderValue2">5.5</span>
            </div>
            <input type="range" min="0" max="10" value="5.5" step="0.5" class="slider" id="slider2" oninput="updateSliderValue(2)">
            <div class="slider-hints">
              <span>Subtil</span>
              <span>Intense</span>
            </div>
          </div>

          <!-- Slider 3: Transformation -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üîÑ Niveau de transformation</label>
              <span class="slider-value" id="sliderValue3">8</span>
            </div>
            <input type="range" min="0" max="10" value="8" class="slider" id="slider3" oninput="updateSliderValue(3)">
            <div class="slider-hints">
              <span>Original</span>
              <span>Transform√©</span>
            </div>
          </div>

          <!-- Slider 4: Structure -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üìê Conservation de la structure</label>
              <span class="slider-value" id="sliderValue4">6</span>
            </div>
            <input type="range" min="0" max="10" value="6" class="slider" id="slider4" oninput="updateSliderValue(4)">
            <div class="slider-hints">
              <span>Libre</span>
              <span>Fid√®le</span>
            </div>
          </div>

          <!-- Presets rapides -->
          <div class="presets-row">
            <button class="preset-btn" onclick="applyPreset('balanced')">‚öñÔ∏è √âquilibr√©</button>
            <button class="preset-btn" onclick="applyPreset('realistic')">üë§ R√©aliste</button>
            <button class="preset-btn" onclick="applyPreset('stylized')">üé® Stylis√©</button>
            <button class="preset-btn" onclick="applyPreset('extreme')">üî• Extr√™me</button>
          </div>
        </div>

        <button class="btn btn-primary generate-btn" id="generateBtn" onclick="generateAvatar()" disabled>
          ‚ú® G√âN√âRER MON AVATAR
        </button>

        <div class="stats" id="userStats">
          <div class="stat">
            <div class="stat-value" id="avatarsUsed">0</div>
            <div class="stat-label">Avatars cr√©√©s</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="avatarsLimit">1</div>
            <div class="stat-label">Limite</div>
          </div>
        </div>
      </div>

      <!-- Result -->
      <div class="card">
        <h2 class="card-title">üñºÔ∏è R√âSULTAT</h2>
        
        <div class="result-zone" id="resultZone">
          <div class="result-placeholder" id="resultPlaceholder">
            <div class="icon">üé≠</div>
            <p>Ton avatar appara√Ætra ici</p>
          </div>
          <img class="result-image" id="resultImage">
          <button class="download-btn" id="downloadBtn" onclick="downloadAvatar()">‚¨áÔ∏è T√©l√©charger</button>
        </div>

        <div class="progress-bar" id="progressBar">
          <div class="progress-fill"></div>
        </div>

        <h2 class="card-title" style="margin-top: 25px;">üìÅ MES AVATARS</h2>
        <div class="gallery" id="gallery">
          <p style="color: var(--text-muted); font-size: 0.9rem;">Aucun avatar pour le moment</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    const API_URL = '';
    let currentUser = null;
    let selectedAvatarTheme = 'default';
    let selectedCharacter = null;
    let uploadedFile = null;
    let lastGeneratedUrl = null;

    const avatarThemes = {
      default: {
        name: 'Spatial', icon: 'üöÄ', premium: false,
        characters: { astronaut: 'Astronaute', alien: 'Alien', bounty_hunter: 'Chasseur', cyborg: 'Cyborg', captain: 'Capitaine' }
      },
      werewolf: {
        name: 'Loup-Garou', icon: 'üê∫', premium: false,
        characters: { werewolf: 'Loup-garou', vampire: 'Vampire', mayor: 'Maire', peasant: 'Paysan', witch: 'Sorci√®re', hunter: 'Chasseur' }
      },
      'wizard-academy': {
        name: 'Sorciers', icon: 'üßô', premium: true,
        characters: { wizard: 'Sorcier', house_elf: 'Elfe', goblin: 'Gobelin', ghost: 'Fant√¥me', professor: 'Professeur' }
      },
      'mythic-realms': {
        name: 'Mythique', icon: '‚öîÔ∏è', premium: true,
        characters: { knight: 'Chevalier', dragon: 'Dragon', dwarf: 'Nain', elf: 'Elfe', orc: 'Orque' }
      }
    };

    // Site theme
    function initSiteTheme() {
      const saved = localStorage.getItem('saboteur_theme') || 'default';
      document.documentElement.setAttribute('data-theme', saved);
      document.querySelectorAll('.theme-btn-mini').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === saved);
      });
    }

    document.querySelectorAll('.theme-btn-mini').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.dataset.theme;
        document.documentElement.setAttribute('data-theme', name);
        localStorage.setItem('saboteur_theme', name);
        document.querySelectorAll('.theme-btn-mini').forEach(b => b.classList.toggle('active', b.dataset.theme === name));
      });
    });

    // Init
    async function init() {
      initSiteTheme();
      
      const token = localStorage.getItem('saboteur_token');
      if (!token) {
        window.location.href = '/?redirect=avatar';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
          const data = await res.json();
          currentUser = data.user;
          updateStats();
          loadMyAvatars();
          
          // Show admin section if admin
          if (currentUser.accountType === 'admin') {
            document.getElementById('adminSection').classList.add('show');
            document.getElementById('customPromptSection').classList.add('show');
          } else if (currentUser.accountType === 'subscriber' || currentUser.accountType === 'pack') {
            document.getElementById('customPromptSection').classList.add('show');
          }
        } else {
          window.location.href = '/';
        }
      } catch (e) { console.error(e); }

      renderAvatarThemes();
      renderCharacters();
    }

    function renderAvatarThemes() {
      const grid = document.getElementById('avatarThemeGrid');
      grid.innerHTML = '';
      const userPremium = currentUser?.accountType !== 'free';

      for (const [key, theme] of Object.entries(avatarThemes)) {
        const locked = theme.premium && !userPremium;
        const btn = document.createElement('button');
        btn.className = `theme-btn ${key === selectedAvatarTheme ? 'active' : ''} ${locked ? 'locked' : ''}`;
        btn.innerHTML = `<span class="icon">${theme.icon}</span><span class="name">${theme.name}</span>${locked ? '<span class="lock">üîí Premium</span>' : ''}`;
        if (!locked) btn.onclick = () => selectAvatarTheme(key);
        grid.appendChild(btn);
      }
    }

    function renderCharacters() {
      const grid = document.getElementById('characterGrid');
      grid.innerHTML = '';
      const theme = avatarThemes[selectedAvatarTheme];
      if (!theme) return;

      for (const [key, name] of Object.entries(theme.characters)) {
        const btn = document.createElement('button');
        btn.className = `character-btn ${key === selectedCharacter ? 'active' : ''}`;
        btn.textContent = name;
        btn.onclick = () => selectCharacter(key);
        grid.appendChild(btn);
      }

      if (selectedCharacter && !theme.characters[selectedCharacter]) selectedCharacter = null;
      updateGenerateButton();
    }

    function selectAvatarTheme(key) {
      selectedAvatarTheme = key;
      document.querySelectorAll('#avatarThemeGrid .theme-btn').forEach(b => b.classList.remove('active'));
      event.currentTarget.classList.add('active');
      renderCharacters();
    }

    function selectCharacter(key) {
      selectedCharacter = key;
      document.querySelectorAll('.character-btn').forEach(b => b.classList.remove('active'));
      event.currentTarget.classList.add('active');
      updateGenerateButton();
    }

    function updateGenerateButton() {
      document.getElementById('generateBtn').disabled = !uploadedFile || !selectedCharacter;
    }

    function updateStats() {
      if (currentUser) {
        document.getElementById('avatarsUsed').textContent = currentUser.avatarsUsed || 0;
        const limits = { free: 1, subscriber: 30, pack: 50, family: 100, admin: '‚àû' };
        document.getElementById('avatarsLimit').textContent = limits[currentUser.accountType] || 1;
      }
    }

    // Upload
    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('uploadPreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('uploadZone').classList.add('has-photo');
        document.querySelector('#uploadZone .icon').style.display = 'none';
        document.querySelectorAll('#uploadZone p').forEach(p => p.style.display = 'none');
      };
      reader.readAsDataURL(file);
      updateGenerateButton();
    });

    // Sliders
    function updateSliderValue(num) {
      const slider = document.getElementById('slider' + num);
      document.getElementById('sliderValue' + num).textContent = slider.value;
    }

    function getSliderValues() {
      return {
        instant_id_strength: parseFloat(document.getElementById('slider1').value) / 10,
        prompt_strength: parseFloat(document.getElementById('slider2').value),
        denoising_strength: parseFloat(document.getElementById('slider3').value) / 10,
        control_depth_strength: parseFloat(document.getElementById('slider4').value) / 10
      };
    }

    function applyPreset(presetName) {
      const presets = {
        balanced: { s1: 5, s2: 5.5, s3: 8, s4: 6 },
        realistic: { s1: 8, s2: 4, s3: 6, s4: 8 },
        stylized: { s1: 3, s2: 7, s3: 9, s4: 4 },
        extreme: { s1: 1, s2: 9, s3: 10, s4: 2 }
      };

      const preset = presets[presetName];
      if (!preset) return;

      document.getElementById('slider1').value = preset.s1;
      document.getElementById('slider2').value = preset.s2;
      document.getElementById('slider3').value = preset.s3;
      document.getElementById('slider4').value = preset.s4;

      updateSliderValue(1);
      updateSliderValue(2);
      updateSliderValue(3);
      updateSliderValue(4);

      showToast(`‚úÖ Preset "${presetName}" appliqu√© !`);
    }

    // Generate
    async function generateAvatar() {
      if (!uploadedFile || !selectedCharacter) return;

      const btn = document.getElementById('generateBtn');
      const progress = document.getElementById('progressBar');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>G√©n√©ration...';
      progress.classList.add('show');
      hideError();

      const formData = new FormData();
      formData.append('photo', uploadedFile);
      formData.append('theme', selectedAvatarTheme);
      formData.append('character', selectedCharacter);

      // Custom prompt
      const customPrompt = document.getElementById('customPrompt').value.trim();
      if (customPrompt && (currentUser.accountType === 'admin' || currentUser.accountType === 'subscriber' || currentUser.accountType === 'pack')) {
        formData.append('customPrompt', customPrompt);
      }

      // Admin sliders
      if (currentUser.accountType === 'admin') {
        const sliders = getSliderValues();
        formData.append('instant_id_strength', sliders.instant_id_strength);
        formData.append('prompt_strength', sliders.prompt_strength);
        formData.append('denoising_strength', sliders.denoising_strength);
        formData.append('control_depth_strength', sliders.control_depth_strength);
      }

      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/generate`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          lastGeneratedUrl = data.url;
          const img = document.getElementById('resultImage');
          img.src = data.url;
          img.style.display = 'block';
          document.getElementById('resultPlaceholder').style.display = 'none';
          document.getElementById('downloadBtn').classList.add('show');
          showToast(`üéâ Avatar "${data.characterName}" cr√©√© !`);
          document.getElementById('avatarsUsed').textContent = data.avatarsUsed;
          loadMyAvatars();
        } else {
          showError(data.error || 'Erreur de g√©n√©ration');
        }
      } catch (e) { 
        showError('Erreur r√©seau'); 
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚ú® G√âN√âRER MON AVATAR';
        progress.classList.remove('show');
        updateGenerateButton();
      }
    }

    // Gallery
    async function loadMyAvatars() {
      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/my-avatars`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        const gallery = document.getElementById('gallery');

        if (data.avatars?.length > 0) {
          gallery.innerHTML = '';
          for (const av of data.avatars) {
            const item = document.createElement('div');
            item.className = `gallery-item ${av.image_url === data.currentAvatar ? 'active' : ''}`;
            item.innerHTML = `
              <img src="${av.image_url}" alt="Avatar" onerror="this.style.display='none'; this.parentElement.classList.add('broken');">
              <button class="delete-avatar-btn" onclick="event.stopPropagation(); deleteAvatar('${av.image_url}', ${av.id})" title="Supprimer">üóëÔ∏è</button>
            `;
            item.onclick = () => setCurrentAvatar(av.image_url);
            gallery.appendChild(item);
          }
        } else {
          gallery.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">Aucun avatar pour le moment</p>';
        }
      } catch (e) { console.error(e); }
    }

    async function deleteAvatar(url, id) {
      if (!confirm('Supprimer cet avatar ?')) return;
      
      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/delete`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ avatarUrl: url, avatarId: id })
        });
        const data = await res.json();
        
        if (data.success) {
          showToast('üóëÔ∏è Avatar supprim√© !');
          loadMyAvatars();
          // Mettre √† jour le compteur
          const used = parseInt(document.getElementById('avatarsUsed').textContent) || 0;
          document.getElementById('avatarsUsed').textContent = Math.max(0, used - 1);
        } else {
          showToast(data.error || 'Erreur', true);
        }
      } catch (e) { 
        showToast('Erreur r√©seau', true);
      }
    }

    async function setCurrentAvatar(url) {
      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/set-current`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ avatarUrl: url })
        });
        if (res.ok) {
          document.querySelectorAll('.gallery-item').forEach(item => {
            item.classList.toggle('active', item.querySelector('img').src.includes(url));
          });
          showToast('‚úÖ Avatar s√©lectionn√© !');
        }
      } catch (e) { showError('Erreur'); }
    }

    function downloadAvatar() {
      if (!lastGeneratedUrl) return;
      const link = document.createElement('a');
      link.href = lastGeneratedUrl;
      link.download = `saboteur-avatar-${Date.now()}.webp`;
      link.click();
    }

    // Messages
    function showError(msg) {
      const banner = document.getElementById('errorBanner');
      banner.textContent = msg;
      banner.classList.add('show');
    }

    function hideError() {
      document.getElementById('errorBanner').classList.remove('show');
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    init();
  </script>
</body>
</html>
