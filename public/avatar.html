<!DOCTYPE html>
<html lang="fr" data-theme="default">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé® Cr√©er mon Avatar - Saboteur</title>
  <link rel="stylesheet" href="auth-themes.css">
  <!-- V32: Socket.IO pour synchro temps r√©el -->
  <script src="/socket.io/socket.io.js"></script>
  
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 80px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header h1 {
      font-family: var(--font-title);
      color: var(--neon-main);
      font-size: clamp(1.5rem, 4vw, 2rem);
      text-shadow: 0 0 15px var(--neon-main);
    }

    .header-buttons {
      display: flex;
      gap: 10px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .card {
      background: linear-gradient(135deg, rgba(10, 14, 26, 0.95) 0%, rgba(26, 31, 53, 0.9) 100%);
      border: 2px solid var(--metal-grey);
      border-radius: calc(var(--border-radius) + 10px);
      padding: 25px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    }

    .card-title {
      font-family: var(--font-title);
      color: var(--neon-main);
      font-size: 1.1rem;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }

    /* Upload Zone */
    .upload-zone {
      border: 3px dashed var(--metal-grey);
      border-radius: var(--border-radius);
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(0, 0, 0, 0.3);
    }

    .upload-zone:hover {
      border-color: var(--neon-main);
      background: rgba(0, 0, 0, 0.4);
    }

    .upload-zone.has-photo { padding: 10px; }
    .upload-zone .icon { font-size: 3rem; margin-bottom: 15px; }
    .upload-zone p { color: var(--text-secondary); }

    .upload-preview {
      max-width: 200px;
      max-height: 200px;
      border-radius: var(--border-radius);
      display: none;
    }

    /* Theme Selector */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .theme-btn {
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid var(--metal-grey);
      border-radius: var(--border-radius);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      font-family: var(--font-body);
    }

    .theme-btn:hover {
      border-color: var(--neon-main);
      color: var(--text-primary);
    }

    .theme-btn.active {
      border-color: var(--neon-main);
      background: rgba(0, 255, 255, 0.1);
      color: var(--neon-main);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    .theme-btn.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .theme-btn .icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
    .theme-btn .name { font-size: 0.85rem; }
    .theme-btn .lock { font-size: 0.7rem; color: var(--neon-orange); }

    /* Character Selector */
    .character-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .character-btn {
      padding: 12px 8px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid var(--metal-grey);
      border-radius: var(--border-radius);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.8rem;
      text-align: center;
      font-family: var(--font-body);
    }

    .character-btn:hover {
      border-color: var(--neon-purple);
      color: var(--text-primary);
    }

    .character-btn.active {
      border-color: var(--neon-purple);
      background: rgba(157, 78, 221, 0.15);
      color: var(--neon-purple);
    }

    /* Admin Sliders Section */
    .admin-section {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      border-radius: var(--border-radius);
    }

    .admin-section.show {
      display: block;
    }

    .admin-section h4 {
      color: #ff6b6b;
      margin-bottom: 15px;
      font-family: var(--font-title);
    }

    .slider-group {
      margin-bottom: 20px;
    }

    .slider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .slider-header label {
      font-size: 0.9em;
      color: var(--text-secondary);
    }

    .slider-value {
      background: rgba(255, 107, 107, 0.3);
      padding: 4px 10px;
      border-radius: 5px;
      font-weight: bold;
      color: #ff6b6b;
      min-width: 40px;
      text-align: center;
    }

    .slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .slider::-moz-range-thumb {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      cursor: pointer;
      border: none;
    }

    .slider-hints {
      display: flex;
      justify-content: space-between;
      font-size: 0.75em;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* Presets */
    .presets-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .preset-btn {
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid var(--metal-grey);
      border-radius: var(--border-radius);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.3s;
    }

    .preset-btn:hover {
      border-color: var(--neon-main);
      color: var(--neon-main);
    }

    /* Custom Prompt */
    .custom-prompt-section {
      display: none;
      margin-top: 20px;
    }

    .custom-prompt-section.show {
      display: block;
    }

    .custom-prompt-section textarea {
      width: 100%;
      padding: 12px;
      border-radius: var(--border-radius);
      border: 2px solid var(--metal-grey);
      background: rgba(0, 0, 0, 0.4);
      color: var(--text-primary);
      resize: vertical;
      min-height: 80px;
      font-family: var(--font-body);
    }

    .custom-prompt-section textarea:focus {
      outline: none;
      border-color: var(--neon-purple);
    }

    /* Result */
    .result-zone {
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--metal-grey);
      border-radius: var(--border-radius);
      background: rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .result-placeholder {
      text-align: center;
      color: var(--text-muted);
    }

    .result-placeholder .icon { font-size: 4rem; margin-bottom: 15px; opacity: 0.5; }

    .result-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: var(--border-radius);
      display: none;
    }

    /* Progress */
    .progress-bar {
      height: 6px;
      background: var(--metal-grey);
      border-radius: 3px;
      margin: 20px 0;
      overflow: hidden;
      display: none;
    }

    .progress-bar.show {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-main), var(--neon-purple));
      border-radius: 3px;
      animation: progress 3s ease-in-out infinite;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* Stats */
    .stats {
      display: flex;
      justify-content: space-around;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      margin-top: 20px;
    }

    .stat { text-align: center; }
    .stat-value { font-family: var(--font-title); font-size: 1.5rem; color: var(--neon-main); }
    .stat-label { font-size: 0.8rem; color: var(--text-muted); }

    /* Generate Button */
    .generate-btn {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      margin-top: 20px;
    }

    /* Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .gallery-item {
      aspect-ratio: 1;
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 2px solid var(--metal-grey);
      cursor: pointer;
      transition: all 0.3s;
    }

    .gallery-item:hover {
      border-color: var(--neon-main);
      transform: scale(1.05);
    }

    .gallery-item.active {
      border-color: var(--neon-green);
      box-shadow: 0 0 15px var(--neon-green);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Avatars classiques (emojis) */
    .classic-avatars-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .classic-avatar-item {
      aspect-ratio: 1;
      border-radius: var(--border-radius);
      border: 2px solid var(--metal-grey);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      background: rgba(0, 0, 0, 0.3);
    }

    .classic-avatar-item:hover {
      border-color: var(--neon-main);
      transform: scale(1.1);
      background: rgba(0, 0, 0, 0.5);
    }

    .classic-avatar-item.active {
      border-color: var(--neon-green);
      box-shadow: 0 0 15px var(--neon-green);
      background: rgba(0, 255, 136, 0.1);
    }

    .section-divider {
      border-top: 1px solid var(--metal-grey);
      margin: 25px 0 15px 0;
      padding-top: 15px;
    }

    /* Bouton suppression avatar */
    .gallery-item {
      position: relative;
    }

    .delete-avatar-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 0, 85, 0.9);
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }

    .gallery-item:hover .delete-avatar-btn {
      opacity: 1;
    }

    .delete-avatar-btn:hover {
      background: var(--neon-red);
      transform: scale(1.1);
    }

    /* Avatar cass√©/manquant */
    .gallery-item.broken {
      background: rgba(255, 0, 85, 0.2);
      border-color: var(--neon-red);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gallery-item.broken::after {
      content: '‚ùå';
      font-size: 2rem;
    }

    .gallery-item.broken .delete-avatar-btn {
      opacity: 1;
    }

    /* Download */
    .download-btn {
      position: absolute;
      bottom: 15px;
      right: 15px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--neon-green);
      border-radius: var(--border-radius);
      color: var(--neon-green);
      cursor: pointer;
      display: none;
      font-family: var(--font-body);
    }

    .download-btn.show {
      display: block;
    }

    .download-btn:hover {
      background: var(--neon-green);
      color: var(--primary-bg);
    }

    /* Error banner */
    .error-banner {
      display: none;
      background: linear-gradient(135deg, rgba(255, 0, 85, 0.2) 0%, rgba(255, 107, 53, 0.2) 100%);
      border: 1px solid var(--neon-red);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 20px;
      color: var(--neon-red);
      text-align: center;
    }

    .error-banner.show {
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--neon-green);
      color: var(--primary-bg);
      padding: 15px 25px;
      border-radius: var(--border-radius);
      display: none;
      z-index: 1001;
      font-weight: 600;
    }

    .toast.show {
      display: block;
      animation: slideUp 0.3s ease;
    }

    .toast.error {
      background: var(--neon-red);
      color: white;
    }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    /* Presets de rendu */
    .preset-section {
      margin: 20px 0;
    }
    .preset-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    @media (max-width: 600px) {
      .preset-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    .preset-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-primary);
    }
    .preset-btn:hover {
      border-color: var(--neon-cyan);
      background: rgba(0, 255, 255, 0.1);
    }
    .preset-btn.active {
      border-color: var(--neon-cyan);
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    .preset-icon {
      font-size: 1.8rem;
    }
    .preset-name {
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--neon-cyan);
    }
    .preset-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    /* V32: Section avatar perso upload/photo */
    .custom-avatar-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .current-custom-avatar {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
    }

    .current-custom-avatar img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--neon-main);
    }

    .current-custom-avatar .avatar-info {
      flex: 1;
    }

    .current-custom-avatar .btn-delete-custom {
      background: var(--neon-red);
      border: none;
      padding: 8px 12px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.85rem;
    }

    .upload-photo-zone {
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: var(--border-radius);
      border: 2px dashed var(--metal-grey);
    }

    .upload-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn-upload, .btn-camera {
      padding: 12px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      border: none;
      transition: all 0.3s;
    }

    .btn-upload {
      background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue));
      color: var(--primary-bg);
    }

    .btn-camera {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      color: white;
    }

    .btn-upload:hover, .btn-camera:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
    }

    .custom-avatar-preview {
      text-align: center;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--border-radius);
      border: 2px solid var(--neon-main);
    }

    .custom-avatar-preview img {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 15px;
      border: 4px solid var(--neon-main);
    }

    .preview-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-success {
      background: var(--neon-green);
      color: var(--primary-bg);
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
    }

    .btn-cancel {
      background: var(--metal-grey);
      color: var(--text-primary);
      border: none;
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
    }

    .btn-success:hover { background: #4ade80; }
    .btn-cancel:hover { background: #555; }

    /* V32: Modal Webcam */
    .webcam-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .webcam-modal.show {
      display: flex;
    }

    .webcam-container {
      position: relative;
      max-width: 400px;
      width: 90%;
    }

    .webcam-video {
      width: 100%;
      border-radius: 10px;
      transform: scaleX(-1); /* Miroir */
    }

    .webcam-canvas {
      display: none;
    }

    .webcam-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .btn-capture {
      background: linear-gradient(135deg, var(--neon-green), #22c55e);
      color: var(--primary-bg);
      border: none;
      padding: 15px 30px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .btn-close-webcam {
      background: var(--metal-grey);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
    }

    .webcam-title {
      color: white;
      font-size: 1.2rem;
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
  
  <!-- Syst√®me de traductions -->
  <script src="translations.js"></script>
</head>
<body>
  <!-- S√©lecteur de th√®me -->
  <div class="theme-selector-mini">
    <button class="theme-btn-mini active" data-theme="default" title="Spatial">üöÄ</button>
    <button class="theme-btn-mini" data-theme="werewolf" title="Loup-Garou">üê∫</button>
    <button class="theme-btn-mini" data-theme="wizard-academy" title="Sorciers">üßô</button>
    <button class="theme-btn-mini" data-theme="mythic-realms" title="Mythique">‚öîÔ∏è</button>
  </div>

  <div class="container">
    <header class="header">
      <h1 data-i18n="avatar.title">üé® CR√âATEUR D'AVATAR IA</h1>
      <div class="header-buttons">
        <a href="/" class="btn btn-secondary">üè† <span data-i18n="game.buttons.backToLobby">Accueil</span></a>
        <a href="/game.html" class="btn btn-primary">üéÆ <span data-i18n="index.profile.playNow">Jouer</span></a>
      </div>
    </header>

    <!-- Error Banner -->
    <div class="error-banner" id="errorBanner"></div>

    <div class="main-grid">
      <!-- Controls -->
      <div class="card">
        <h2 class="card-title">üì∏ <span data-i18n="avatar.sections.uploadPhoto">TA PHOTO</span></h2>
        
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('photoInput').click()">
          <div class="icon">üì∑</div>
          <p data-i18n="avatar.sections.uploadPhoto">Clique pour ajouter ta photo</p>
          <p style="font-size: 0.8rem; margin-top: 10px; color: var(--text-muted);" data-i18n="avatar.sections.selfieRecommended">Selfie de face recommand√©</p>
          <img class="upload-preview" id="uploadPreview">
        </div>
        <input type="file" id="photoInput" accept="image/*" style="display: none">
        <input type="file" id="cameraPhotoInput" accept="image/*" capture="user" style="display: none">
        
        <!-- Bouton prendre photo avec cam√©ra -->
        <div style="text-align: center; margin-top: 10px;">
          <button class="btn btn-camera" onclick="openWebcam('ia')" style="padding: 10px 20px;" data-i18n="avatar.sections.takePhoto">
            üì∑ Prendre une photo
          </button>
        </div>

        <h2 class="card-title" style="margin-top: 25px;" data-i18n="avatar.sections.theme">üé® TH√àME DE L'AVATAR</h2>
        <div class="theme-grid" id="avatarThemeGrid"></div>

        <h2 class="card-title" data-i18n="avatar.sections.character">üë§ PERSONNAGE</h2>
        <div class="character-grid" id="characterGrid"></div>

        <!-- Presets de rendu (comptes gratuits et premium non-admin) -->
        <div class="preset-section" id="presetSection">
          <h2 class="card-title" data-i18n="avatar.sections.style">üî• STYLE DE RENDU</h2>
          <div class="preset-grid" id="presetGrid">
            <button class="preset-btn active" data-preset="standard" onclick="selectPreset('standard')">
              <span class="preset-icon">üéØ</span>
              <span class="preset-name" data-i18n="avatar.styles.standard.name">Standard</span>
              <span class="preset-desc" data-i18n="avatar.styles.standard.desc">√âquilibr√©</span>
            </button>
            <button class="preset-btn" data-preset="transformed" onclick="selectPreset('transformed')">
              <span class="preset-icon">üî•</span>
              <span class="preset-name" data-i18n="avatar.styles.transformed.name">Transform√©</span>
              <span class="preset-desc" data-i18n="avatar.styles.transformed.desc">Plus stylis√©</span>
            </button>
            <button class="preset-btn" data-preset="artistic" onclick="selectPreset('artistic')">
              <span class="preset-icon">‚ú®</span>
              <span class="preset-name" data-i18n="avatar.styles.artistic.name">Artistique</span>
              <span class="preset-desc" data-i18n="avatar.styles.artistic.desc">Tr√®s stylis√©</span>
            </button>
          </div>
        </div>

        <!-- Custom Prompt (Premium/Admin) -->
        <div class="custom-prompt-section" id="customPromptSection">
          <h2 class="card-title" data-i18n="avatar.sections.customPrompt">‚ú® PROMPT PERSONNALIS√â</h2>
          <textarea id="customPrompt" data-i18n-placeholder="avatar.messages.customPromptPlaceholder" placeholder="D√©cris ton personnage personnalis√©..."></textarea>
        </div>

        <!-- Admin Sliders -->
        <div class="admin-section" id="adminSection">
          <h4>üîß Param√®tres avanc√©s (Admin)</h4>
          
          <!-- Slider 1: Ressemblance -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üë§ Ressemblance au visage</label>
              <span class="slider-value" id="sliderValue1">5</span>
            </div>
            <input type="range" min="0" max="10" value="5" class="slider" id="slider1" oninput="updateSliderValue(1)">
            <div class="slider-hints">
              <span>Stylis√©</span>
              <span>Fid√®le</span>
            </div>
          </div>

          <!-- Slider 2: Force du style -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üé® Force du style/prompt</label>
              <span class="slider-value" id="sliderValue2">5.5</span>
            </div>
            <input type="range" min="0" max="10" value="5.5" step="0.5" class="slider" id="slider2" oninput="updateSliderValue(2)">
            <div class="slider-hints">
              <span>Subtil</span>
              <span>Intense</span>
            </div>
          </div>

          <!-- Slider 3: Transformation -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üîÑ Niveau de transformation</label>
              <span class="slider-value" id="sliderValue3">8</span>
            </div>
            <input type="range" min="0" max="10" value="8" class="slider" id="slider3" oninput="updateSliderValue(3)">
            <div class="slider-hints">
              <span>Original</span>
              <span>Transform√©</span>
            </div>
          </div>

          <!-- Slider 4: Structure -->
          <div class="slider-group">
            <div class="slider-header">
              <label>üìê Conservation de la structure</label>
              <span class="slider-value" id="sliderValue4">6</span>
            </div>
            <input type="range" min="0" max="10" value="6" class="slider" id="slider4" oninput="updateSliderValue(4)">
            <div class="slider-hints">
              <span>Libre</span>
              <span>Fid√®le</span>
            </div>
          </div>

          <!-- Presets rapides -->
          <div class="presets-row">
            <button class="preset-btn" onclick="applyPreset('balanced')">‚öñÔ∏è √âquilibr√©</button>
            <button class="preset-btn" onclick="applyPreset('realistic')">üë§ R√©aliste</button>
            <button class="preset-btn" onclick="applyPreset('stylized')">üé® Stylis√©</button>
            <button class="preset-btn" onclick="applyPreset('extreme')">üî• Extr√™me</button>
          </div>
        </div>

        <button class="btn btn-primary generate-btn" id="generateBtn" onclick="generateAvatar()" disabled data-i18n="avatar.buttons.generate">
          üé® G√âN√âRER MON AVATAR
        </button>

        <div class="stats" id="userStats">
          <div class="stat">
            <div class="stat-value" id="avatarsUsed">0</div>
            <div class="stat-label">Avatars cr√©√©s</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="avatarsLimit">1</div>
            <div class="stat-label">Limite</div>
          </div>
        </div>
      </div>

      <!-- Result -->
      <div class="card">
        <h2 class="card-title" data-i18n="avatar.sections.result">üñºÔ∏è R√âSULTAT</h2>
        
        <div class="result-zone" id="resultZone">
          <div class="result-placeholder" id="resultPlaceholder">
            <div class="icon">üé≠</div>
            <p data-i18n="avatar.messages.avatarAppears">Ton avatar appara√Ætra ici</p>
          </div>
          <img class="result-image" id="resultImage">
          <button class="download-btn" id="downloadBtn" onclick="downloadAvatar()" data-i18n="avatar.buttons.download">‚¨áÔ∏è T√©l√©charger</button>
        </div>

        <div class="progress-bar" id="progressBar">
          <div class="progress-fill"></div>
        </div>

        <h2 class="card-title" style="margin-top: 25px;" data-i18n="avatar.sections.myAvatars">üìÅ MES AVATARS IA</h2>
        <div class="gallery" id="gallery">
          <p style="color: var(--text-muted); font-size: 0.9rem;" data-i18n="avatar.messages.noAvatars">Aucun avatar pour le moment</p>
        </div>

        <!-- V32: Section avatar perso (upload/photo) -->
        <div class="section-divider" id="customAvatarSection" style="display: none;">
          <h2 class="card-title" data-i18n="avatar.sections.myCustomAvatar">üì§ MON AVATAR PERSO</h2>
          <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;" data-i18n="avatar.messages.uploadInfo">
            Importe ta propre photo (1 seul avatar perso autoris√©)
          </p>
          
          <div class="custom-avatar-container">
            <!-- Avatar actuel -->
            <div class="current-custom-avatar" id="currentCustomAvatar">
              <p style="color: var(--text-muted); font-size: 0.85rem;" data-i18n="avatar.messages.noCustomAvatar">Aucun avatar perso</p>
            </div>
            
            <!-- Zone upload/photo -->
            <div class="upload-photo-zone" id="uploadPhotoZone">
              <input type="file" id="customAvatarInput" accept="image/*" style="display: none;">
              <input type="file" id="cameraInput" accept="image/*" capture="user" style="display: none;">
              
              <div class="upload-buttons">
                <button class="btn btn-upload" onclick="document.getElementById('customAvatarInput').click()" data-i18n="avatar.buttons.importImage">
                  üìÅ Importer une image
                </button>
                <button class="btn btn-camera" onclick="openWebcam('custom')" data-i18n="avatar.sections.takePhoto">
                  üì∑ Prendre une photo
                </button>
              </div>
              
              <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 10px;" data-i18n="avatar.messages.formatInfo">
                Formats accept√©s : JPG, PNG, WebP ‚Ä¢ Max 5 Mo ‚Ä¢ Sera redimensionn√© en 256√ó256
              </p>
            </div>
            
            <!-- Preview avant validation -->
            <div class="custom-avatar-preview" id="customAvatarPreview" style="display: none;">
              <img id="previewImg" src="" alt="Preview">
              <div class="preview-buttons">
                <button class="btn btn-success" onclick="confirmCustomAvatar()" data-i18n="avatar.buttons.use">‚úÖ Utiliser cet avatar</button>
                <button class="btn btn-cancel" onclick="cancelCustomAvatar()" data-i18n="game.actions.cancel">‚ùå Annuler</button>
              </div>
            </div>
          </div>
        </div>

        <div class="section-divider">
          <h2 class="card-title" data-i18n="avatar.sections.classicAvatars">üé≠ AVATARS CLASSIQUES</h2>
          <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 15px;" data-i18n="avatar.messages.chooseEmoji">Choisis un emoji comme avatar (sans photo)</p>
          <div class="classic-avatars-grid" id="classicAvatarsGrid">
            <!-- Les emojis seront ajout√©s par JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- V32: Modal Webcam -->
  <div class="webcam-modal" id="webcamModal">
    <p class="webcam-title" data-i18n="avatar.sections.takePhoto">üì∑ Prendre une photo</p>
    <div class="webcam-container">
      <video id="webcamVideo" class="webcam-video" autoplay playsinline></video>
      <canvas id="webcamCanvas" class="webcam-canvas"></canvas>
    </div>
    <div class="webcam-buttons">
      <button class="btn-capture" onclick="captureWebcamPhoto()">üì∏ Capturer</button>
      <button class="btn-close-webcam" onclick="closeWebcam()">‚ùå Fermer</button>
    </div>
  </div>

  <script>
    const API_URL = '';
    let currentUser = null;
    let selectedAvatarTheme = 'default';
    let selectedCharacter = null;
    let uploadedFile = null;
    let lastGeneratedUrl = null;
    
    // V32: Webcam
    let webcamStream = null;
    let webcamMode = null; // 'ia' ou 'custom'

    const avatarThemes = {
      default: {
        name: 'Spatial', icon: 'üöÄ', premium: false,
        characters: { astronaut: 'Astronaute', alien: 'Alien', bounty_hunter: 'Chasseur', cyborg: 'Cyborg', captain: 'Capitaine' }
      },
      werewolf: {
        name: 'Loup-Garou', icon: 'üê∫', premium: false,
        characters: { werewolf: 'Loup-garou', vampire: 'Vampire', mayor: 'Maire', peasant: 'Paysan', witch: 'Sorci√®re', hunter: 'Chasseur' }
      },
      'wizard-academy': {
        name: 'Sorciers', icon: 'üßô', premium: true,
        characters: { wizard: 'Sorcier', house_elf: 'Elfe', goblin: 'Gobelin', ghost: 'Fant√¥me', professor: 'Professeur' }
      },
      'mythic-realms': {
        name: 'Mythique', icon: '‚öîÔ∏è', premium: true,
        characters: { knight: 'Chevalier', dragon: 'Dragon', dwarf: 'Nain', elf: 'Elfe', orc: 'Orque' }
      }
    };

    // Presets de rendu (valeurs pour prompt_strength et denoising_strength)
    const renderPresets = {
      standard: { 
        name: 'Standard', 
        prompt_strength: 4.5, 
        denoising_strength: 0.65,
        instant_id_strength: 0.8,
        control_depth_strength: 0.8
      },
      transformed: { 
        name: 'Transform√©', 
        prompt_strength: 6.0, 
        denoising_strength: 0.75,
        instant_id_strength: 0.6,
        control_depth_strength: 0.7
      },
      artistic: { 
        name: 'Artistique', 
        prompt_strength: 7.5, 
        denoising_strength: 0.85,
        instant_id_strength: 0.5,
        control_depth_strength: 0.6
      }
    };
    let selectedPreset = 'standard';

    function selectPreset(presetId) {
      selectedPreset = presetId;
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.preset === presetId);
      });
      console.log('[Preset] S√©lectionn√©:', presetId, renderPresets[presetId]);
    }

    // Site theme
    function initSiteTheme() {
      const saved = localStorage.getItem('saboteur_theme') || 'default';
      document.documentElement.setAttribute('data-theme', saved);
      document.querySelectorAll('.theme-btn-mini').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === saved);
      });
    }

    document.querySelectorAll('.theme-btn-mini').forEach(btn => {
      btn.addEventListener('click', () => {
        const name = btn.dataset.theme;
        document.documentElement.setAttribute('data-theme', name);
        localStorage.setItem('saboteur_theme', name);
        document.querySelectorAll('.theme-btn-mini').forEach(b => b.classList.toggle('active', b.dataset.theme === name));
      });
    });

    // Init
    async function init() {
      initSiteTheme();
      
      // V32: Initialiser le socket pour la synchro temps r√©el
      initSocket();
      
      const token = localStorage.getItem('saboteur_token');
      if (!token) {
        window.location.href = '/?redirect=avatar';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
          const data = await res.json();
          currentUser = data.user;
          updateStats();
          loadMyAvatars();
          
          // Show admin section if admin (hide presets, show sliders)
          if (currentUser.accountType === 'admin') {
            document.getElementById('adminSection').classList.add('show');
            document.getElementById('customPromptSection').classList.add('show');
            document.getElementById('presetSection').style.display = 'none'; // Admin a les sliders
          } else if (currentUser.accountType === 'subscriber' || currentUser.accountType === 'pack') {
            document.getElementById('customPromptSection').classList.add('show');
            document.getElementById('presetSection').style.display = 'block'; // Premium voit les presets
          } else {
            // Compte gratuit : presets visibles, pas de prompt perso
            document.getElementById('presetSection').style.display = 'block';
          }
        } else {
          window.location.href = '/';
        }
      } catch (e) { console.error(e); }

      renderAvatarThemes();
      renderCharacters();
    }
    
    // V32: Initialiser le socket (connexion au serveur)
    function initSocket() {
      try {
        window.socket = io(window.location.origin, {
          transports: ['websocket', 'polling'],
          timeout: 10000
        });
        
        window.socket.on('connect', () => {
          console.log('[Avatar] Socket connect√©');
        });
        
        window.socket.on('disconnect', () => {
          console.log('[Avatar] Socket d√©connect√©');
        });
      } catch (e) {
        console.log('[Avatar] Erreur socket:', e);
      }
    }

    function renderAvatarThemes() {
      const grid = document.getElementById('avatarThemeGrid');
      grid.innerHTML = '';
      const userPremium = currentUser?.accountType !== 'free';

      for (const [key, theme] of Object.entries(avatarThemes)) {
        const locked = theme.premium && !userPremium;
        const btn = document.createElement('button');
        btn.className = `theme-btn ${key === selectedAvatarTheme ? 'active' : ''} ${locked ? 'locked' : ''}`;
        btn.innerHTML = `<span class="icon">${theme.icon}</span><span class="name">${theme.name}</span>${locked ? '<span class="lock">üîí Premium</span>' : ''}`;
        if (!locked) btn.onclick = () => selectAvatarTheme(key);
        grid.appendChild(btn);
      }
    }

    function renderCharacters() {
      const grid = document.getElementById('characterGrid');
      grid.innerHTML = '';
      const theme = avatarThemes[selectedAvatarTheme];
      if (!theme) return;

      for (const [key, name] of Object.entries(theme.characters)) {
        const btn = document.createElement('button');
        btn.className = `character-btn ${key === selectedCharacter ? 'active' : ''}`;
        btn.textContent = name;
        btn.onclick = () => selectCharacter(key);
        grid.appendChild(btn);
      }

      if (selectedCharacter && !theme.characters[selectedCharacter]) selectedCharacter = null;
      updateGenerateButton();
    }

    function selectAvatarTheme(key) {
      selectedAvatarTheme = key;
      document.querySelectorAll('#avatarThemeGrid .theme-btn').forEach(b => b.classList.remove('active'));
      event.currentTarget.classList.add('active');
      renderCharacters();
    }

    function selectCharacter(key) {
      selectedCharacter = key;
      document.querySelectorAll('.character-btn').forEach(b => b.classList.remove('active'));
      event.currentTarget.classList.add('active');
      updateGenerateButton();
    }

    function updateGenerateButton() {
      document.getElementById('generateBtn').disabled = !uploadedFile || !selectedCharacter;
    }

    function updateStats() {
      if (currentUser) {
        document.getElementById('avatarsUsed').textContent = currentUser.avatarsUsed || 0;
        const limits = { free: 1, subscriber: 30, pack: 50, family: 100, admin: '‚àû' };
        document.getElementById('avatarsLimit').textContent = limits[currentUser.accountType] || 1;
      }
    }

    // Upload
    document.getElementById('photoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('uploadPreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('uploadZone').classList.add('has-photo');
        document.querySelector('#uploadZone .icon').style.display = 'none';
        document.querySelectorAll('#uploadZone p').forEach(p => p.style.display = 'none');
      };
      reader.readAsDataURL(file);
      updateGenerateButton();
    });

    // V32: Cam√©ra pour photo IA (m√™me logique que photoInput)
    document.getElementById('cameraPhotoInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        const preview = document.getElementById('uploadPreview');
        preview.src = e.target.result;
        preview.style.display = 'block';
        document.getElementById('uploadZone').classList.add('has-photo');
        document.querySelector('#uploadZone .icon').style.display = 'none';
        document.querySelectorAll('#uploadZone p').forEach(p => p.style.display = 'none');
      };
      reader.readAsDataURL(file);
      updateGenerateButton();
    });

    // Sliders
    function updateSliderValue(num) {
      const slider = document.getElementById('slider' + num);
      document.getElementById('sliderValue' + num).textContent = slider.value;
    }

    function getSliderValues() {
      return {
        instant_id_strength: parseFloat(document.getElementById('slider1').value) / 10,
        prompt_strength: parseFloat(document.getElementById('slider2').value),
        denoising_strength: parseFloat(document.getElementById('slider3').value) / 10,
        control_depth_strength: parseFloat(document.getElementById('slider4').value) / 10
      };
    }

    function applyPreset(presetName) {
      const presets = {
        balanced: { s1: 5, s2: 5.5, s3: 8, s4: 6 },
        realistic: { s1: 8, s2: 4, s3: 6, s4: 8 },
        stylized: { s1: 3, s2: 7, s3: 9, s4: 4 },
        extreme: { s1: 1, s2: 9, s3: 10, s4: 2 }
      };

      const preset = presets[presetName];
      if (!preset) return;

      document.getElementById('slider1').value = preset.s1;
      document.getElementById('slider2').value = preset.s2;
      document.getElementById('slider3').value = preset.s3;
      document.getElementById('slider4').value = preset.s4;

      updateSliderValue(1);
      updateSliderValue(2);
      updateSliderValue(3);
      updateSliderValue(4);

      showToast(`‚úÖ Preset "${presetName}" appliqu√© !`);
    }

    // Generate
    async function generateAvatar() {
      if (!uploadedFile || !selectedCharacter) return;

      const btn = document.getElementById('generateBtn');
      const progress = document.getElementById('progressBar');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>G√©n√©ration...';
      progress.classList.add('show');
      hideError();

      const formData = new FormData();
      formData.append('photo', uploadedFile);
      formData.append('theme', selectedAvatarTheme);
      formData.append('character', selectedCharacter);

      // Custom prompt
      const customPrompt = document.getElementById('customPrompt').value.trim();
      if (customPrompt && (currentUser.accountType === 'admin' || currentUser.accountType === 'subscriber' || currentUser.accountType === 'pack')) {
        formData.append('customPrompt', customPrompt);
      }

      // Admin sliders
      if (currentUser.accountType === 'admin') {
        const sliders = getSliderValues();
        formData.append('instant_id_strength', sliders.instant_id_strength);
        formData.append('prompt_strength', sliders.prompt_strength);
        formData.append('denoising_strength', sliders.denoising_strength);
        formData.append('control_depth_strength', sliders.control_depth_strength);
      } else {
        // Utiliser les presets pour les non-admins
        const preset = renderPresets[selectedPreset] || renderPresets.standard;
        formData.append('instant_id_strength', preset.instant_id_strength);
        formData.append('prompt_strength', preset.prompt_strength);
        formData.append('denoising_strength', preset.denoising_strength);
        formData.append('control_depth_strength', preset.control_depth_strength);
        console.log('[Generate] Preset utilis√©:', selectedPreset, preset);
      }

      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/generate`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          lastGeneratedUrl = data.url;
          const img = document.getElementById('resultImage');
          img.src = data.url;
          img.style.display = 'block';
          document.getElementById('resultPlaceholder').style.display = 'none';
          document.getElementById('downloadBtn').classList.add('show');
          showToast(`üéâ Avatar "${data.characterName}" cr√©√© !`);
          document.getElementById('avatarsUsed').textContent = data.avatarsUsed;
          loadMyAvatars();
        } else {
          showError(data.error || 'Erreur de g√©n√©ration');
        }
      } catch (e) { 
        showError('Erreur r√©seau'); 
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚ú® G√âN√âRER MON AVATAR';
        progress.classList.remove('show');
        updateGenerateButton();
      }
    }

    // Gallery
    async function loadMyAvatars() {
      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/my-avatars`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        const gallery = document.getElementById('gallery');

        // V√©rifier si c'est un compte gratuit (pas de suppression autoris√©e)
        const savedUser = localStorage.getItem('saboteur_user');
        const isFreeAccount = savedUser && JSON.parse(savedUser).accountType === 'free';

        if (data.avatars?.length > 0) {
          gallery.innerHTML = '';
          for (const av of data.avatars) {
            const item = document.createElement('div');
            item.className = `gallery-item ${av.image_url === data.currentAvatar ? 'active' : ''}`;
            
            // Ne pas afficher le bouton de suppression pour les comptes gratuits
            const deleteBtn = isFreeAccount ? '' : 
              `<button class="delete-avatar-btn" onclick="event.stopPropagation(); deleteAvatar('${av.image_url}', ${av.id})" title="Supprimer">üóëÔ∏è</button>`;
            
            item.innerHTML = `
              <img src="${av.image_url}" alt="Avatar" onerror="this.style.display='none'; this.parentElement.classList.add('broken');">
              ${deleteBtn}
            `;
            item.onclick = () => setCurrentAvatar(av.image_url);
            gallery.appendChild(item);
          }
        } else {
          gallery.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">Aucun avatar pour le moment</p>';
        }
      } catch (e) { console.error(e); }
    }

    async function deleteAvatar(url, id) {
      if (!confirm('Supprimer cet avatar ?')) return;
      
      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/delete`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ avatarUrl: url, avatarId: id })
        });
        const data = await res.json();
        
        if (data.success) {
          showToast('üóëÔ∏è Avatar supprim√© !');
          loadMyAvatars();
          // Mettre √† jour le compteur
          const used = parseInt(document.getElementById('avatarsUsed').textContent) || 0;
          document.getElementById('avatarsUsed').textContent = Math.max(0, used - 1);
        } else {
          showToast(data.error || 'Erreur', true);
        }
      } catch (e) { 
        showToast('Erreur r√©seau', true);
      }
    }

    async function setCurrentAvatar(url) {
      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/set-current`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ avatarUrl: url })
        });
        if (res.ok) {
          document.querySelectorAll('.gallery-item').forEach(item => {
            item.classList.toggle('active', item.querySelector('img').src.includes(url));
          });
          showToast('‚úÖ Avatar s√©lectionn√© !');
        }
      } catch (e) { showError('Erreur'); }
    }

    function downloadAvatar() {
      if (!lastGeneratedUrl) return;
      const link = document.createElement('a');
      link.href = lastGeneratedUrl;
      link.download = `saboteur-avatar-${Date.now()}.webp`;
      link.click();
    }

    // Messages
    function showError(msg) {
      const banner = document.getElementById('errorBanner');
      banner.textContent = msg;
      banner.classList.add('show');
    }

    function hideError() {
      document.getElementById('errorBanner').classList.remove('show');
    }

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ========================================
    // AVATARS CLASSIQUES (EMOJIS)
    // ========================================
    
    // Emojis existants des th√®mes (d9-avatars.js) + quelques extras
    const classicAvatars = [
      // Spatial
      'üßë‚ÄçüöÄ', 'ü§ñ', 'üëΩ', 'üöÄ', 'üõ∞Ô∏è', 'üõ∏', '‚≠ê', 'üåô', 'ü™ê', '‚òÑÔ∏è',
      // Loup-Garou
      'üê∫', 'üë®‚Äçüåæ', 'üßô‚Äç‚ôÄÔ∏è', 'üèπ', 'üîÆ', 'üåï', 'üå≤', 'ü¶â', 'ü¶á', 'üíÄ',
      // Sorciers
      'üßô‚Äç‚ôÇÔ∏è', 'ü™Ñ', 'üß™', 'üìñ', 'üêà‚Äç‚¨õ', '‚öóÔ∏è', '‚ú®', 'üêâ',
      // Mythique  
      '‚öîÔ∏è', 'üõ°Ô∏è', 'üßù', 'üßù‚Äç‚ôÄÔ∏è', 'ü¶Ñ', 'üî•', 'üíé', 'üìú'
    ];

    let currentClassicAvatar = null;

    function renderClassicAvatars() {
      const grid = document.getElementById('classicAvatarsGrid');
      if (!grid) return;
      
      // R√©cup√©rer l'avatar actuel du localStorage
      const savedUser = localStorage.getItem('saboteur_user');
      let savedEmoji = null;
      if (savedUser) {
        try {
          const user = JSON.parse(savedUser);
          // Si l'avatar actuel est un emoji (pas une URL)
          if (user.currentAvatar && !user.currentAvatar.startsWith('http')) {
            savedEmoji = user.currentAvatar;
          }
        } catch(e) {}
      }
      
      grid.innerHTML = '';
      classicAvatars.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'classic-avatar-item' + (emoji === savedEmoji ? ' active' : '');
        item.textContent = emoji;
        item.onclick = () => selectClassicAvatar(emoji);
        grid.appendChild(item);
      });
    }

    async function selectClassicAvatar(emoji) {
      try {
        const token = localStorage.getItem('saboteur_token');
        const res = await fetch(`${API_URL}/api/avatars/set-current`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({ avatarUrl: emoji }) // On envoie l'emoji comme "avatarUrl"
        });
        
        if (res.ok) {
          // Mettre √† jour la s√©lection visuelle
          document.querySelectorAll('.classic-avatar-item').forEach(item => {
            item.classList.toggle('active', item.textContent === emoji);
          });
          // D√©sactiver la s√©lection des avatars IA
          document.querySelectorAll('.gallery-item').forEach(item => {
            item.classList.remove('active');
          });
          
          // Mettre √† jour le localStorage
          const savedUser = localStorage.getItem('saboteur_user');
          if (savedUser) {
            const user = JSON.parse(savedUser);
            user.currentAvatar = emoji;
            localStorage.setItem('saboteur_user', JSON.stringify(user));
          }
          
          // V32: Synchroniser avec le socket si en partie
          syncAvatarWithSocket(emoji);
          
          currentClassicAvatar = emoji;
          showToast(`‚úÖ Avatar "${emoji}" s√©lectionn√© !`);
        }
      } catch (e) { 
        console.error(e);
        showToast('Erreur', true); 
      }
    }

    // V32: Fonction pour synchroniser l'avatar avec le socket (mise √† jour en temps r√©el)
    function syncAvatarWithSocket(avatarUrl) {
      const playerId = sessionStorage.getItem('is_playerId');
      const roomCode = sessionStorage.getItem('is_roomCode');
      
      if (playerId && roomCode && window.socket && window.socket.connected) {
        window.socket.emit('updateCustomization', {
          playerId,
          roomCode,
          avatarUrl: avatarUrl
        }, (response) => {
          if (response?.ok) {
            console.log('[Avatar] Synchro socket r√©ussie');
          } else {
            console.log('[Avatar] Synchro socket √©chou√©e:', response?.error);
          }
        });
      } else {
        console.log('[Avatar] Pas de partie en cours, synchro socket ignor√©e');
      }
    }

    // Modifier loadMyAvatars pour g√©rer la s√©lection crois√©e
    const originalLoadMyAvatars = loadMyAvatars;
    loadMyAvatars = async function() {
      await originalLoadMyAvatars();
      
      // V√©rifier si l'avatar actuel est un emoji (pas une URL)
      const savedUser = localStorage.getItem('saboteur_user');
      if (savedUser) {
        try {
          const user = JSON.parse(savedUser);
          if (user.currentAvatar && !user.currentAvatar.startsWith('http')) {
            // C'est un emoji, s'assurer que les avatars IA ne sont pas s√©lectionn√©s
            document.querySelectorAll('.gallery-item').forEach(item => {
              item.classList.remove('active');
            });
          }
        } catch(e) {}
      }
    };

    // Modifier setCurrentAvatar pour d√©sactiver les avatars classiques quand on s√©lectionne un avatar IA
    const originalSetCurrentAvatar = setCurrentAvatar;
    setCurrentAvatar = async function(url) {
      await originalSetCurrentAvatar(url);
      // D√©sactiver tous les avatars classiques
      document.querySelectorAll('.classic-avatar-item').forEach(item => {
        item.classList.remove('active');
      });
      currentClassicAvatar = null;
      
      // Mettre √† jour le localStorage
      const savedUser = localStorage.getItem('saboteur_user');
      if (savedUser) {
        const user = JSON.parse(savedUser);
        user.currentAvatar = url;
        localStorage.setItem('saboteur_user', JSON.stringify(user));
      }
      
      // V32: Synchroniser avec le socket si en partie
      syncAvatarWithSocket(url);
    };

    // Initialiser les avatars classiques au chargement
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(renderClassicAvatars, 500);
      setTimeout(initCustomAvatarSection, 600);
    });

    // ========================================
    // V32: AVATAR PERSO (UPLOAD / PHOTO)
    // ========================================
    
    let customAvatarFile = null;
    
    function initCustomAvatarSection() {
      const section = document.getElementById('customAvatarSection');
      if (!section) return;
      
      // V√©rifier si l'utilisateur a un compte v√©rifi√©
      const token = localStorage.getItem('saboteur_token');
      const savedUser = localStorage.getItem('saboteur_user');
      
      if (!token || !savedUser) {
        section.style.display = 'none';
        return;
      }
      
      try {
        const user = JSON.parse(savedUser);
        // Afficher seulement si email v√©rifi√©
        if (user.emailVerified) {
          section.style.display = 'block';
          loadCurrentCustomAvatar();
        }
      } catch(e) {
        section.style.display = 'none';
      }
      
      // Event listeners pour les inputs
      document.getElementById('customAvatarInput')?.addEventListener('change', handleCustomAvatarSelect);
      document.getElementById('cameraInput')?.addEventListener('change', handleCustomAvatarSelect);
    }
    
    async function loadCurrentCustomAvatar() {
      const container = document.getElementById('currentCustomAvatar');
      if (!container) return;
      
      const token = localStorage.getItem('saboteur_token');
      if (!token) return;
      
      try {
        const res = await fetch(`${API_URL}/api/avatar/my-custom`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        if (data.ok && data.customAvatar) {
          container.innerHTML = `
            <img src="${data.customAvatar}" alt="Mon avatar perso" onerror="this.style.display='none'; this.nextElementSibling.querySelector('.fallback-text').style.display='block';">
            <div class="avatar-info">
              <p style="color: var(--neon-main); font-weight: 600;">Mon avatar perso</p>
              <span class="fallback-text" style="display: none; color: var(--neon-red); font-size: 0.75rem;">‚ö†Ô∏è Image introuvable</span>
              <button class="btn btn-use-custom" onclick="useCustomAvatar('${data.customAvatar}')" style="margin-top: 5px; padding: 5px 10px; background: var(--neon-green); border: none; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">‚úÖ Utiliser</button>
            </div>
            <button class="btn-delete-custom" onclick="deleteCustomAvatar()">üóëÔ∏è Supprimer</button>
          `;
          document.getElementById('uploadPhotoZone').style.display = 'none';
        } else {
          container.innerHTML = `<p style="color: var(--text-muted); font-size: 0.85rem;">Aucun avatar perso</p>`;
          document.getElementById('uploadPhotoZone').style.display = 'block';
        }
      } catch(e) {
        console.error('Erreur chargement avatar perso:', e);
      }
    }
    
    function handleCustomAvatarSelect(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      
      // V√©rifier le type
      if (!file.type.startsWith('image/')) {
        showToast('‚ùå Fichier non valide. Choisis une image.', true);
        return;
      }
      
      // V√©rifier la taille (max 5 Mo)
      if (file.size > 5 * 1024 * 1024) {
        showToast('‚ùå Image trop lourde (max 5 Mo)', true);
        return;
      }
      
      customAvatarFile = file;
      
      // Afficher preview
      const reader = new FileReader();
      reader.onload = (event) => {
        const preview = document.getElementById('customAvatarPreview');
        const previewImg = document.getElementById('previewImg');
        
        previewImg.src = event.target.result;
        preview.style.display = 'block';
        document.getElementById('uploadPhotoZone').style.display = 'none';
      };
      reader.readAsDataURL(file);
    }
    
    function cancelCustomAvatar() {
      customAvatarFile = null;
      document.getElementById('customAvatarPreview').style.display = 'none';
      document.getElementById('uploadPhotoZone').style.display = 'block';
      document.getElementById('customAvatarInput').value = '';
      document.getElementById('cameraInput').value = '';
    }
    
    async function confirmCustomAvatar() {
      if (!customAvatarFile) return;
      
      const token = localStorage.getItem('saboteur_token');
      if (!token) {
        showToast('‚ùå Connecte-toi d\'abord', true);
        return;
      }
      
      showToast('‚è≥ Upload en cours...');
      
      try {
        // Redimensionner et convertir en WebP
        const resizedBlob = await resizeAndConvertImage(customAvatarFile, 256, 256);
        
        // Cr√©er FormData
        const formData = new FormData();
        formData.append('avatar', resizedBlob, 'custom-avatar.webp');
        
        const res = await fetch(`${API_URL}/api/avatar/upload-custom`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        const data = await res.json();
        
        if (data.ok) {
          showToast('‚úÖ Avatar perso enregistr√© !');
          cancelCustomAvatar();
          loadCurrentCustomAvatar();
          
          // Utiliser automatiquement cet avatar
          useCustomAvatar(data.avatarUrl);
        } else {
          showToast('‚ùå ' + (data.error || 'Erreur upload'), true);
        }
      } catch(e) {
        console.error('Erreur upload:', e);
        showToast('‚ùå Erreur r√©seau', true);
      }
    }
    
    function useCustomAvatar(url) {
      setCurrentAvatar(url);
      showToast('‚úÖ Avatar perso activ√© !');
    }
    
    async function deleteCustomAvatar() {
      if (!confirm('Supprimer ton avatar perso ?')) return;
      
      const token = localStorage.getItem('saboteur_token');
      if (!token) return;
      
      try {
        const res = await fetch(`${API_URL}/api/avatar/delete-custom`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        if (data.ok) {
          showToast('‚úÖ Avatar supprim√©');
          loadCurrentCustomAvatar();
        } else {
          showToast('‚ùå ' + (data.error || 'Erreur'), true);
        }
      } catch(e) {
        showToast('‚ùå Erreur r√©seau', true);
      }
    }
    
    // Redimensionner et convertir en WebP
    function resizeAndConvertImage(file, maxWidth, maxHeight) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          // Calculer les dimensions (carr√© centr√©)
          const size = Math.min(img.width, img.height);
          const sx = (img.width - size) / 2;
          const sy = (img.height - size) / 2;
          
          const canvas = document.createElement('canvas');
          canvas.width = maxWidth;
          canvas.height = maxHeight;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, sx, sy, size, size, 0, 0, maxWidth, maxHeight);
          
          canvas.toBlob(
            (blob) => resolve(blob),
            'image/webp',
            0.85  // Qualit√© 85%
          );
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // ========================================
    // V32: WEBCAM FUNCTIONS
    // ========================================
    
    async function openWebcam(mode) {
      webcamMode = mode;
      
      // D√©tecter si on est sur mobile
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // Sur mobile, utiliser l'input capture natif
        if (mode === 'ia') {
          document.getElementById('cameraPhotoInput').click();
        } else {
          document.getElementById('cameraInput').click();
        }
        return;
      }
      
      // Sur PC, ouvrir le modal webcam
      try {
        webcamStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
          audio: false 
        });
        
        const video = document.getElementById('webcamVideo');
        video.srcObject = webcamStream;
        
        document.getElementById('webcamModal').classList.add('show');
        
      } catch (err) {
        console.error('Erreur webcam:', err);
        showToast('‚ùå Impossible d\'acc√©der √† la cam√©ra. V√©rifie les permissions.', true);
      }
    }
    
    function closeWebcam() {
      // Arr√™ter le stream
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
      }
      
      document.getElementById('webcamModal').classList.remove('show');
      webcamMode = null;
    }
    
    function captureWebcamPhoto() {
      const video = document.getElementById('webcamVideo');
      const canvas = document.getElementById('webcamCanvas');
      
      // Configurer le canvas √† la taille de la vid√©o
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      const ctx = canvas.getContext('2d');
      
      // Inverser horizontalement (miroir) pour correspondre √† ce que l'utilisateur voit
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      
      // Convertir en blob
      canvas.toBlob((blob) => {
        // Cr√©er un fichier √† partir du blob
        const file = new File([blob], 'webcam-photo.jpg', { type: 'image/jpeg' });
        
        if (webcamMode === 'ia') {
          // Pour avatar IA
          uploadedFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('uploadPreview');
            preview.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('uploadZone').classList.add('has-photo');
            document.querySelector('#uploadZone .icon').style.display = 'none';
            document.querySelectorAll('#uploadZone p').forEach(p => p.style.display = 'none');
          };
          reader.readAsDataURL(file);
          updateGenerateButton();
          showToast('‚úÖ Photo captur√©e !');
        } else {
          // Pour avatar perso (custom)
          customAvatarFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('customAvatarPreview');
            const previewImg = document.getElementById('previewImg');
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('uploadPhotoZone').style.display = 'none';
          };
          reader.readAsDataURL(file);
          showToast('‚úÖ Photo captur√©e !');
        }
        
        closeWebcam();
      }, 'image/jpeg', 0.9);
    }

    init();
    
    // Traduire la page au chargement
    if (typeof translatePage === 'function') {
      translatePage();
    }
  </script>
</body>
</html>
