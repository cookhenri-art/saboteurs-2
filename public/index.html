<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‚ö° INFILTRATION SPATIALE ‚ö°</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="topLeftButtons" style="
    position: fixed; left: 20px; top: 20px; z-index: 9999;
    display:flex; gap:10px; align-items:center;
  ">
    <button id="rulesBtn" class="btn btn-secondary" style="
      padding: 10px 16px; border-radius: 10px; font-weight: 800;
    ">üìú R√àGLES</button>
    <button id="soundBtn" class="btn btn-secondary" style="
      padding: 10px 16px; border-radius: 10px; font-weight: 900;
      min-width: 56px;
    " title="Couper / r√©activer le son">üîä</button>
  </div>

  <div class="container">
    <div class="header">
      <div class="logo"></div>
      <h1>INFILTRATION SPATIALE</h1>
      <div class="subtitle">‚ö° MISSION TEMPS R√âEL ‚ö°</div>
      <div id="buildBadge" style="margin-top:10px; opacity:.85; font-size:.95rem;"></div>
      <div id="topBanner" style="display:none; margin-top:12px; color: var(--neon-orange); font-weight:700; letter-spacing:1px;"></div>
    </div>

    <!-- HOME -->
    <div id="homeScreen" class="screen active">
      <div class="control-panel">
        <div class="form-group">
          <label for="playerName">Nom du joueur</label>
          <input type="text" id="playerName" placeholder="Entrez votre nom" maxlength="20">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="createBtn">Cr√©er une Mission</button>
          <button class="btn btn-secondary" id="joinBtn">Rejoindre une Mission</button>
        </div>
      </div>
    </div>

    <!-- CREATE -->
    <div id="createScreen" class="screen">
      <div class="control-panel">
        <h2 class="panel-title">CR√âER UNE MISSION</h2>
        <div class="btn-group">
          <button class="btn btn-primary" id="createRoomBtn">G√©n√©rer Code Mission</button>
          <button class="btn btn-secondary" id="backFromCreate">Retour</button>
        </div>
      </div>
    </div>

    <!-- JOIN -->
    <div id="joinScreen" class="screen">
      <div class="control-panel">
        <h2 class="panel-title">REJOINDRE UNE MISSION</h2>
        <div class="form-group">
          <label for="joinRoomCode">Num√©ro de salle</label>
          <input type="text" id="joinRoomCode" placeholder="0000" maxlength="4">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="joinRoomBtn">Connexion</button>
          <button class="btn btn-secondary" id="backFromJoin">Retour</button>
        </div>
      </div>
    </div>

    <!-- LOBBY (cockpit style) -->
    <div id="lobbyScreen" class="screen">
      <div style="width: 100%; max-width: 1200px; margin: 0 auto;
          background: linear-gradient(135deg, #0a0e27 0%, #1a1e3f 50%, #0a0e27 100%);
          border: 3px solid var(--metal-grey); border-radius: 20px; padding: 40px;
          box-shadow: 0 0 60px rgba(0,255,255,0.3), inset 0 0 100px rgba(0,0,0,0.5);">

        <div style="text-align: center; margin-bottom: 40px; position: relative;">
          <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
              width: min(420px, 92vw); height: 62px; background: rgba(0,255,255,0.1);
              border: 2px solid var(--neon-cyan); border-radius: 10px;"></div>
          <h1 style="color: var(--neon-cyan); font-size: clamp(1.6rem, 6vw, 2.2rem); margin: 0; padding: 10px; white-space: nowrap; line-height: 1.1; letter-spacing: 2px;
              text-shadow: 0 0 30px var(--neon-cyan); position: relative;">
            STAR INFILTRATOR
          </h1>
        </div>

        <div style="display:flex; justify-content:space-between; gap:18px; flex-wrap:wrap;">
          <div>
            <div style="color: var(--neon-orange); font-size: 1rem; margin-bottom: 5px;">CODE MISSION</div>
            <div id="displayRoomCode" style="color: var(--neon-cyan); font-size: 2.5rem;
                font-weight: bold; text-shadow: 0 0 20px var(--neon-cyan);">0000</div>
          </div>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <button class="btn btn-secondary" id="readyBtn">‚úÖ PR√äT</button>
            <button class="btn btn-primary" id="startGameBtn" style="display:none;">üöÄ Lancer Mission</button>
          </div>
        </div>

        <div style="text-align: center; margin: 40px 0;">
          <div id="playerCount" style="font-size: 7rem; color: var(--neon-cyan);
              text-shadow: 0 0 80px var(--neon-cyan); font-weight: 900;
              font-family: 'Orbitron', sans-serif;">0</div>
          <div style="color: var(--metal-grey); font-size: 1.1rem; margin-top: -10px;">MEMBRES D'√âQUIPAGE</div>
        </div>

        <div style="margin: 25px 0;">
          <div style="position: relative; height: 50px;
              background: linear-gradient(to right, var(--neon-cyan) 0%, var(--neon-cyan) 50%, var(--neon-red) 50%, var(--neon-red) 100%);
              border-radius: 25px; overflow: hidden; border: 3px solid var(--metal-grey);
              box-shadow: 0 0 30px rgba(0,255,255,0.5), inset 0 0 30px rgba(0,0,0,0.8);">
            <div id="balanceIndicatorCockpit" style="position: absolute; top: 50%; left: 50%;
                transform: translate(-50%, -50%); width: 26px; height: 26px;
                background: var(--neon-green); border-radius: 50%;
                box-shadow: 0 0 40px var(--neon-green); border: 3px solid white;
                transition: left 0.3s ease;"></div>
          </div>
          <div style="display:flex; justify-content:space-between; margin-top:12px; padding: 0 10px; gap:12px; flex-wrap:wrap;">
            <span style="color: var(--neon-cyan); font-size: 1.1rem; font-weight:bold;">üë®‚ÄçüöÄ ASTRONAUTES</span>
            <span id="balanceStatusCockpit" style="color: var(--neon-green); font-size: 1.1rem; font-weight:bold;">MISSION BALANCED</span>
            <span style="color: var(--neon-red); font-size: 1.1rem; font-weight:bold;">SABOTEURS ‚öîÔ∏è</span>
          </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-top: 20px;">
          <div style="background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px;
              border: 2px solid var(--neon-cyan); box-shadow: 0 0 20px rgba(0,255,255,0.3);">
            <h3 style="color: var(--neon-cyan); margin:0 0 12px 0; font-size:1.2rem; text-align:center;">AUTO-ALLOCATION</h3>
            <div id="autoAllocation" style="color: var(--neon-cyan); font-size: 1.05rem; line-height:1.8;"></div>
          </div>
          <div style="background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px;
              border: 2px solid var(--neon-orange); box-shadow: 0 0 20px rgba(255,165,0,0.3);">
            <h3 style="color: var(--neon-orange); margin:0 0 12px 0; font-size:1.2rem; text-align:center;">CONFIG R√îLES (H√îTE)</h3>
            <div id="rolesConfig"></div>
          </div>
        </div>
      </div>

      <div class="control-panel" style="margin-top: 20px;">
        <h2 class="panel-title">√âQUIPAGE CONNECT√â</h2>
        <div class="players-list" id="playersList"></div>
      </div>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="screen">
      <div id="gameBackdrop" style="width:100%; height:180px; border-radius:16px; overflow:hidden; border:2px solid var(--neon-cyan);
        background-size:cover; background-position:center; margin-bottom: 16px; position:relative;">
        <img id="ejectionOverlay" src="/images/ejection.png" alt="ejection" style="display:none; position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.28; pointer-events:none;">
      </div>
      <div id="deadBanner" style="display:none; margin-bottom: 12px; padding:10px 12px; border-radius:12px; border:2px solid var(--neon-red); color: var(--neon-red); font-weight:900; text-align:center;">üíÄ Vous avez √©t√© √©ject√©</div>

      <div class="control-panel" style="max-width: 900px;">
        <div style="display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; align-items:center;">
          <div>
            <div style="opacity:.85; letter-spacing:2px; font-family:'Orbitron',sans-serif; font-size:.9rem;">MISSION</div>
            <div id="hudRoom" style="font-size:1.6rem; font-weight:900; letter-spacing:3px;"></div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div id="roleIcons" style="display:flex; gap:8px; align-items:center;"></div>
            <div id="linkBanner" style="display:none; padding:6px 10px; border:2px solid var(--neon-orange); border-radius:10px; color:var(--neon-orange); font-weight:800;"></div>
          </div>
        </div>

        <div style="margin-top: 18px;">
          <div id="phaseTitle" class="panel-title" style="margin-bottom:10px;">‚Äî</div>
          <div id="phaseText" style="font-size:1.1rem; line-height:1.4; opacity:.95;"></div>
          <div id="ackLine" style="margin-top:10px; color: var(--neon-green); font-weight:800;"></div>
        </div>

        <div id="controls" style="margin-top: 18px;"></div>
        <div id="log" style="margin-top:16px; max-height:220px; overflow:auto; padding:10px; border-radius:12px;
          background: rgba(0,0,0,0.35); border:1px solid rgba(0,255,255,0.25);"></div>
      </div>
    </div>

    <!-- END -->
    <div id="endScreen" class="screen">
      <div id="endBackdrop" style="width:100%; height:180px; border-radius:16px; overflow:hidden; border:2px solid var(--neon-cyan);
        background-size:cover; background-position:center; margin-bottom: 16px;"></div>
      <div class="control-panel" style="max-width: 900px;">
        <h2 class="panel-title winner-title" id="winnerTitle"></h2>
        <div id="endSummary" style="margin-bottom:16px;"></div>
        <div class="ranking-table" id="rankingTable"></div>

        <div class="btn-group" style="margin-top: 18px;">
          <button class="btn btn-primary" id="replayBtn">üîÅ Rejouer dans cette chambre (garder les stats)</button>
          <button class="btn btn-secondary" id="newGameBtn">üÜï Nouvelle partie (r√©initialiser les stats)</button>
        </div>
      </div>
    </div>

    <div id="errorDisplay"></div>
  </div>

  <!-- Rules modal -->
  <div id="rulesModal" style="display:none; position:fixed; inset:0; z-index:10000; background: rgba(0,0,0,0.75);">
    <div style="max-width: 900px; margin: 5vh auto; background: linear-gradient(135deg, var(--dark-panel), #0d1f3a);
      border:2px solid var(--neon-cyan); border-radius: 16px; padding: 18px; position: relative;">
      <button id="rulesClose" class="btn btn-secondary" style="position:absolute; right:12px; top:12px;">‚úñ</button>
      <div class="panel-title">R√àGLES</div>
      <div id="rulesContent" style="line-height:1.45; font-size:1.05rem; max-height: 75vh; overflow:auto; padding-right:10px;"></div>
    </div>
  </div>

  <!-- Boot: ensure Socket.IO client is available (works on Render + local; shows a clear error if server not running) -->
  <script>
    (function () {
      function loadScript(src) {
        return new Promise(function (resolve) {
          var s = document.createElement('script');
          s.src = src;
          s.async = true;
          s.onload = function () { resolve(true); };
          s.onerror = function () { resolve(false); };
          document.head.appendChild(s);
        });
      }

      function loadClient() {
        var s = document.createElement('script');
        s.src = 'client.js';
        s.async = true;
        document.body.appendChild(s);
      }

      // Try local first (Render/local). If not available (e.g., opened via file://), fallback to CDN
      loadScript('/socket.io/socket.io.js').then(function () {
        if (typeof window.io === 'undefined') {
          return loadScript('https://cdn.socket.io/4.7.5/socket.io.min.js');
        }
        return true;
      }).then(loadClient);
    })();
  </script>
</body>
</html>
