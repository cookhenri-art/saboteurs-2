<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé≠ LES SABOTEURS - D4 Briefing üé≠</title>
  <!-- D10: PWA Meta Tags -->
  <meta name="description" content="Saboteur - Un jeu multijoueur de d√©duction sociale avec vid√©o int√©gr√©e.">
  <meta name="theme-color" content="#00ffff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Saboteur">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.webp">

  <!-- Polices pour th√®me Default (Spatial) -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Polices pour th√®me Werewolf (Village) -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Polices pour th√®me Wizard Academy (Acad√©mie) -->
  <link href="https://fonts.googleapis.com/css2?family=Philosopher:wght@400;700&family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Polices pour th√®me Mythic Realms (Royaume) -->
  <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Uncial+Antiqua:wght@700&family=Lora:wght@400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Bouton R√àGLES en haut √† gauche -->
  <div id="topLeftButtons" style="
    position: fixed; left: 10px; top: 10px; z-index: 9999;
  ">
    <button id="rulesBtn" class="btn btn-secondary" style="
      padding: 10px 16px; border-radius: 10px; font-weight: 800;
    ">üìú <span class="rulesBtnText">R√àGLES</span></button>
  </div>
  
  <!-- Bouton APP en bas √† gauche (s√©par√© pour √©viter conflits tactiles) -->
  <div id="installAppContainer" style="
    position: fixed; left: 10px; bottom: 80px; z-index: 9998;
  ">
    <button id="installAppBtn" type="button" style="
      padding: 10px 14px; border-radius: 12px; font-weight: 800;
      display: flex; align-items: center; gap: 8px;
      background: linear-gradient(135deg, rgba(10,14,26,0.95) 0%, rgba(0,255,255,0.15) 100%);
      border: 2px solid var(--neon-cyan, #00ffff);
      color: var(--neon-cyan, #00ffff);
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
      font-family: inherit;
      font-size: 0.9rem;
    ">
      <img src="/icons/icon-192x192.webp" alt="App" style="width: 28px; height: 28px; border-radius: 6px;">
      <span>APP</span>
      <span style="font-size: 1.2rem;">‚¨áÔ∏è</span>
    </button>
  </div>
  
  <!-- Bouton MUTE √† droite -->
  <div id="topRightButtons" style="
    position: fixed; right: 20px; top: 20px; z-index: 9999;
  ">
    <button id="soundBtn" class="btn btn-secondary" style="
      padding: 10px 16px; border-radius: 10px; font-weight: 900;
      min-width: 56px;
    " title="Couper / r√©activer le son">üîä</button>
  </div>

  <div class="container">
    <!-- Audio Unlock Overlay -->
    <div id="audioUnlockOverlay" style="
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 99999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 20px;
    ">
      <div style="font-size: 4rem; animation: pulse 1.5s infinite;">üîä</div>
      <div style="font-size: 1.5rem; color: var(--neon-cyan); font-weight: 800; text-align: center;">
        CLIQUEZ POUR ACTIVER LE SON
      </div>
      <button id="audioUnlockBtn" class="btn btn-primary" style="
        padding: 20px 40px;
        font-size: 1.3rem;
        font-weight: 900;
        animation: glow 1.5s infinite;
      ">üéµ ACTIVER L'AUDIO</button>
    </div>
    
    <div class="header">
      <div class="logo"></div>
      <h1 id="mainTitle">INFILTRATION SPATIALE</h1>
      <div class="subtitle">‚ö° MISSION TEMPS R√âEL ‚ö°</div>
      <div id="buildBadge" style="margin-top:10px; opacity:.85; font-size:.95rem;"></div>
      <div id="topBanner" style="display:none; margin-top:12px; color: var(--neon-orange); font-weight:700; letter-spacing:1px;"></div>
    </div>

    <!-- HOME -->
    <div id="homeScreen" class="screen active">
      <div style="width: 100%; max-width: 800px; margin: 0 auto;
          background: linear-gradient(135deg, #0a0e27 0%, #1a1e3f 50%, #0a0e27 100%);
          border: 3px solid var(--metal-grey); border-radius: 20px; padding: 40px;
          box-shadow: 0 0 60px rgba(0,255,255,0.3), inset 0 0 100px rgba(0,0,0,0.5);">
        
        <!-- Titre Principal -->
        <div style="text-align: center; margin-bottom: 40px;">
          <h1 style="color: var(--neon-cyan); font-size: clamp(2rem, 6vw, 3rem); margin: 0; 
              text-shadow: 0 0 30px var(--neon-cyan); letter-spacing: 3px;">
            LES SABOTEURS
          </h1>
          <p style="color: var(--neon-green); margin-top: 10px; font-size: 1rem; opacity: 0.8;">
            Jeu de d√©duction sociale multijoueur
          </p>
        </div>

        <!-- S√©lecteur de Th√®me - Cach√© car choisi sur l'accueil -->
        <div id="homeThemeSelectorContainer" style="display: none; margin-bottom: 30px; padding: 20px; border-radius: 12px; 
            border: 2px solid rgba(0, 255, 255, 0.3); background: rgba(0, 0, 0, 0.4);">
          <div style="text-align: center; margin-bottom: 15px;">
            <span style="color: var(--neon-cyan); font-weight: 700; font-size: 1.1rem;">
              üé® CHOIX DU TH√àME
            </span>
          </div>
          <div id="homeThemeSelector" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
            <!-- Les boutons seront g√©n√©r√©s par JS -->
          </div>
          <div id="homeThemeDescription" style="text-align: center; margin-top: 15px; 
              color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; min-height: 24px;">
          </div>
        </div>

        <!-- Formulaire -->
        <div style="padding: 20px; border-radius: 12px; 
            border: 2px solid var(--neon-cyan); background: rgba(0, 255, 255, 0.05);">
          <div class="form-group" style="margin-bottom: 20px;">
            <label for="playerName" style="color: var(--neon-cyan); font-weight: 700; margin-bottom: 8px; display: block;">
              NOM DU JOUEUR
            </label>
            <input type="text" id="playerName" placeholder="Entrez votre nom" maxlength="20"
                style="width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px;
                background: rgba(0, 0, 0, 0.6); border: 2px solid rgba(0, 255, 255, 0.3);
                color: white; outline: none; transition: all 0.3s;">
          </div>
          <div class="btn-group" style="display: flex; gap: 10px; flex-direction: column;">
            <button class="btn btn-primary" id="createBtn" style="padding: 15px; font-size: 1.1rem;">
              üöÄ CR√âER UNE MISSION
            </button>
            <button class="btn btn-secondary" id="joinBtn" style="padding: 15px; font-size: 1.1rem;">
              üîó REJOINDRE UNE MISSION
            </button>
          </div>
        </div>

      </div>
    </div>

    <!-- CREATE -->
    <div id="createScreen" class="screen">
      <div class="control-panel">
        <h2 class="panel-title" id="createMissionTitle">CR√âER UNE MISSION</h2>
        <div class="btn-group">
          <button class="btn btn-primary" id="createRoomBtn">G√©n√©rer Code Mission</button>
          <button class="btn btn-secondary" id="backFromCreate">Retour</button>
        </div>
      </div>
    </div>

    <!-- JOIN -->
    <div id="joinScreen" class="screen">
      <div class="control-panel">
        <h2 class="panel-title" id="joinMissionTitle">REJOINDRE UNE MISSION</h2>
        <div class="form-group">
          <label for="joinRoomCode">Num√©ro de salle</label>
          <input type="text" id="joinRoomCode" placeholder="0000" maxlength="4">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="joinRoomBtn">Connexion</button>
          <button class="btn btn-secondary" id="backFromJoin">Retour</button>
        </div>
      </div>
    </div>

    <!-- LOBBY (cockpit style) -->
    <div id="lobbyScreen" class="screen">
      <div style="width: 100%; max-width: 1200px; margin: 0 auto;
          background: linear-gradient(135deg, #0a0e27 0%, #1a1e3f 50%, #0a0e27 100%);
          border: 3px solid var(--metal-grey); border-radius: 20px; padding: 40px;
          box-shadow: 0 0 60px rgba(0,255,255,0.3), inset 0 0 100px rgba(0,0,0,0.5);">

        <div style="text-align: center; margin-bottom: 40px; position: relative; display:flex; flex-direction:column; align-items:center;">
          <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%);
              width: min(380px, 86vw); height: 62px; background: rgba(0,255,255,0.1);
              border: 2px solid var(--neon-cyan); border-radius: 10px;"></div>
	          <h1 class="lobby-title-text" style="display:flex; align-items:center; justify-content:center;
              color: var(--neon-cyan); font-size: clamp(1.3rem, 5vw, 1.9rem);
              margin: 0; padding: 0 10px; height: 62px; box-sizing: border-box;
	              white-space: nowrap; line-height: 62px; letter-spacing: 2px;
              max-width: min(380px, 86vw); overflow: hidden; text-overflow: ellipsis;
              text-shadow: 0 0 30px var(--neon-cyan); position: relative; text-align:center;">
            LES SABOTEURS
          </h1>
        </div>

        <div style="display:flex; justify-content:space-between; gap:18px; flex-wrap:wrap;">
          <div>
            <div style="color: var(--neon-orange); font-size: 1rem; margin-bottom: 5px;">CODE MISSION</div>
            <div id="displayRoomCode" style="color: var(--neon-cyan); font-size: 2.5rem;
                font-weight: bold; text-shadow: 0 0 20px var(--neon-cyan);">0000</div>
          </div>
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <button class="btn btn-secondary" id="readyBtn">‚úÖ PR√äT</button>
            <button class="btn btn-primary" id="startGameBtn" style="display:none;">üöÄ Lancer Mission</button>
          </div>
        </div>

        <div style="text-align: center; margin: 40px 0;">
          <div id="playerCount" style="font-size: 7rem; color: var(--neon-cyan);
              text-shadow: 0 0 80px var(--neon-cyan); font-weight: 900;
              font-family: 'Orbitron', sans-serif;">0</div>
          <div style="color: var(--metal-grey); font-size: 1.1rem; margin-top: -10px;">MEMBRES D'√âQUIPAGE</div>
        </div>

        <div style="margin: 25px 0;">
          <div style="position: relative; height: 50px;
              background: linear-gradient(to right, var(--neon-cyan) 0%, var(--neon-cyan) 50%, var(--neon-red) 50%, var(--neon-red) 100%);
              border-radius: 25px; overflow: hidden; border: 3px solid var(--metal-grey);
              box-shadow: 0 0 30px rgba(0,255,255,0.5), inset 0 0 30px rgba(0,0,0,0.8);">
            <div id="balanceIndicatorCockpit" style="position: absolute; top: 50%; left: 50%;
                transform: translate(-50%, -50%); width: 26px; height: 26px;
                background: var(--neon-green); border-radius: 50%;
                box-shadow: 0 0 40px var(--neon-green); border: 3px solid white;
                transition: left 0.3s ease;"></div>
          </div>
	          <div id="balanceLabelsCockpit" style="display:flex; justify-content:space-between; margin-top:12px; padding: 0 10px; gap:12px; flex-wrap:wrap;">
	            <span id="balanceLabelLeft" style="color: var(--neon-cyan); font-size: 1.1rem; font-weight:bold;">ASTRONAUTES</span>
	            <span id="balanceStatusCockpit" style="color: var(--neon-green); font-size: 1.1rem; font-weight:bold; display:none;">MISSION BALANCED</span>
	            <span id="balanceLabelRight" style="color: var(--neon-red); font-size: 1.1rem; font-weight:bold;">SABOTEURS</span>
	          </div>
        </div>

        <!-- Phrase de r√©partition simple -->
        <div id="autoAllocation" style="text-align: center; margin: 20px 0 15px 0; 
            color: var(--neon-cyan); font-size: 1.05rem; opacity: 0.9;"></div>

        <!-- Config r√¥les en pleine largeur -->
        <div style="background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px;
            border: 2px solid var(--neon-orange); box-shadow: 0 0 20px rgba(255,165,0,0.3);">
          <h3 style="color: var(--neon-orange); margin:0 0 12px 0; font-size:1.2rem; text-align:center;">CONFIG R√îLES (H√îTE)</h3>
          <div id="rolesConfig"></div>
        </div>

        <!-- S√©lection de th√®me (h√¥te uniquement) -->
        <div id="themeSelector" style="display:none; margin-top: 20px; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px;
            border: 2px solid var(--neon-purple, #9d4edd); box-shadow: 0 0 20px rgba(157,78,221,0.3);">
          <h3 style="color: var(--neon-purple, #9d4edd); margin:0 0 12px 0; font-size:1.2rem; text-align:center;">üé® TH√àME (H√îTE)</h3>
          <div id="themeButtons" style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;"></div>
          <div id="themeDescription" style="margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.4); border-radius: 8px; color: #ccc; font-size: 0.95rem; text-align: center; min-height: 40px;"></div>
        </div>

        <!-- V9.3.1: Options vid√©o (h√¥te uniquement) -->
        <div id="videoOptions" style="display:none; margin-top: 20px; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 15px;
            border: 2px solid var(--neon-cyan); box-shadow: 0 0 20px rgba(0,255,255,0.3);">
          <h3 style="color: var(--neon-cyan); margin:0 0 12px 0; font-size:1.2rem; text-align:center;">üìπ OPTIONS VID√âO (H√îTE)</h3>
          <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
            <label style="display: flex; align-items: center; gap: 8px; color: #ccc; font-size: 1rem; cursor: pointer;">
              <input type="checkbox" id="disableVideoCheckbox" style="width: 20px; height: 20px; cursor: pointer;">
              <span>D√©sactiver la vid√©o pour cette partie</span>
            </label>
          </div>
          <div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.4); border-radius: 8px; color: #999; font-size: 0.9rem; text-align: center;">
            <span id="videoOptionDescription" style="font-size: 0.95rem; line-height: 1.5;">Ce mode est id√©al pour des parties avec cartes, sans ma√Ætre du jeu. L'application remplacera ce dernier. L'h√¥te peut cocher le mode manuel dans la configuration des r√¥les, pour que chaque joueur renseigne sa carte de r√¥le re√ßue.</span>
          </div>
        </div>
      </div>

      <div class="control-panel" style="margin-top: 20px;">
        <h2 class="panel-title" id="connectedPlayersTitle">√âQUIPAGE CONNECT√â</h2>
        <div class="players-list" id="playersList"></div>
      </div>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="screen">
      <div id="gameBackdrop" style="width:100%; height:250px; border-radius:16px; overflow:hidden; border:2px solid var(--neon-cyan);
        background-size:cover; background-position:center 45%; margin-bottom: 16px; position:relative;">
        <img id="ejectionOverlay" src="/images/default/out.webp" alt="ejection" style="display:none; position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.28; pointer-events:none;">
      </div>
      <div id="deadBanner" style="display:none; margin-bottom: 12px; padding:10px 12px; border-radius:12px; border:2px solid var(--neon-red); color: var(--neon-red); font-weight:900; text-align:center;">üíÄ Vous avez √©t√© √©limin√©</div>

      <div class="control-panel" style="max-width: 900px;">
        <div style="display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; align-items:center;">
          <div>
            <div style="opacity:.85; letter-spacing:2px; font-family:'Orbitron',sans-serif; font-size:.9rem;">MISSION</div>
            <div id="hudRoom" style="font-size:1.6rem; font-weight:900; letter-spacing:3px;"></div>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div id="roleIcons" style="display:flex; gap:8px; align-items:center;"></div>
            <div id="linkBanner" style="display:none; padding:6px 10px; border:2px solid var(--neon-orange); border-radius:10px; color:var(--neon-orange); font-weight:800;"></div>
          </div>
        </div>

        
        <!-- VIDEO DOCK (prototype) : visio int√©gr√©e √† l'UI en phase de discussion -->
        <div id="videoDockSlot">
          <div id="videoDockSlotHeader">
            <div class="title">üìπ VISIO (discussion)</div>
            <div class="actions">
              <button id="videoDockExpandBtn" type="button" title="Ouvrir en fen√™tre">‚§¢</button>
              <button id="videoDockHideBtn" type="button" title="Masquer la visio">‚úï</button>
            </div>
          </div>
          <div id="videoDockSlotBody"></div>
        </div>

<div style="margin-top: 18px;">
          <div id="phaseTitle" class="panel-title" style="margin-bottom:10px;">‚Äî</div>
          <div id="phaseText" style="font-size:1.1rem; line-height:1.4; opacity:.95;"></div>
          <div id="ackLine" style="margin-top:10px; color: var(--neon-green); font-weight:800;"></div>
        </div>

        <div id="controls" style="margin-top: 18px;"></div>
        
        <!-- Panneau de contr√¥le h√¥te (force advance) -->
        <div id="hostControls" style="display:none; margin-top: 18px; padding: 15px; background: rgba(255,165,0,0.1); border: 2px solid var(--neon-orange); border-radius: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
              <div style="color: var(--neon-orange); font-weight: 800; font-size: 1.1rem; margin-bottom: 5px;">‚ö° CONTR√îLES H√îTE</div>
              <div id="phaseTimer" style="color: #ccc; font-size: 0.9rem;">Phase active depuis : <span id="phaseElapsed">0s</span></div>
              <div id="pendingPlayers" style="margin-top: 5px; color: #999; font-size: 0.85rem;"></div>
            </div>
            <button id="forceAdvanceBtn" class="btn" style="background: var(--neon-orange); color: #000; font-weight: 800; padding: 12px 20px; opacity: 0.5; cursor: not-allowed;" disabled>
              ‚è≠Ô∏è Forcer la suite (20s min)
            </button>
          </div>
        </div>
        
        <div id="log" style="margin-top:16px; max-height:220px; overflow:auto; padding:10px; border-radius:12px;
          background: rgba(0,0,0,0.35); border:1px solid rgba(0,255,255,0.25);"></div>
      </div>
    </div>

    <!-- END -->
    <div id="endScreen" class="screen">
      <div id="endBackdrop" style="width:100%; height:250px; border-radius:16px; overflow:hidden; border:2px solid var(--neon-cyan);
        background-size:cover; background-position:center 45%; margin-bottom: 16px;"></div>
      <div class="control-panel" style="max-width: 900px;">
        <h2 class="panel-title winner-title" id="winnerTitle"></h2>
        <div id="endSummary" style="margin-bottom:16px;"></div>
        
        <!-- Badges d√©bloqu√©s cette partie -->
        <div id="newBadgesSection" style="display:none; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, rgba(157,78,221,0.2), rgba(255,165,0,0.2)); border: 2px solid var(--neon-purple, #9d4edd); border-radius: 15px;">
          <h3 style="color: var(--neon-purple, #9d4edd); margin: 0 0 15px 0; text-align: center; font-size: 1.4rem;">üèÜ BADGES D√âBLOQU√âS</h3>
          <div id="newBadgesList" style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;"></div>
        </div>
        
        <div class="ranking-table" id="rankingTable"></div>

        <div class="btn-group" style="margin-top: 18px;">
          <button class="btn btn-primary" id="replayBtn">üîÅ Rejouer dans cette chambre (garder les stats)</button>
          <button class="btn btn-secondary" id="newGameBtn">üÜï Nouvelle partie (r√©initialiser les stats)</button>
        </div>
      </div>
    </div>

    <div id="errorDisplay"></div>
  </div>

  <!-- Rules modal -->
  <div id="rulesModal" style="display:none; position:fixed; inset:0; z-index:10000; background: rgba(0,0,0,0.75); overflow-y:auto;">
    <div style="max-width: 900px; margin: 2vh auto; max-height: 96vh; background: linear-gradient(135deg, var(--dark-panel), #0d1f3a);
      border:2px solid var(--neon-cyan); border-radius: 16px; padding: 18px; position: relative; display:flex; flex-direction:column;">
      <button id="rulesClose" class="btn btn-secondary" style="position:absolute; right:12px; top:12px; z-index:1;">‚úñ</button>
      <div class="panel-title" style="flex-shrink:0;">R√àGLES</div>
      <div id="rulesContent" style="line-height:1.45; font-size:1.05rem; flex:1; overflow-y:auto; padding-right:10px; min-height:0;"></div>
      <button id="tutorialBtn" class="btn btn-primary" style="margin-top: 15px; width: 100%; flex-shrink:0;">üìñ Voir le tutoriel rapide</button>
    </div>
  </div>

  <!-- Tutorial modal -->
  <div id="tutorialModal" style="display:none; position:fixed; inset:0; z-index:10001; background: rgba(0,0,0,0.85); overflow-y:auto;">
    <div style="max-width: 700px; margin: 2vh auto; max-height: 96vh; background: linear-gradient(135deg, var(--primary-bg), var(--secondary-bg));
      border:3px solid var(--neon-cyan); border-radius: 20px; padding: 20px; position: relative; box-shadow: 0 0 60px var(--neon-cyan); display:flex; flex-direction:column;">
      <button id="tutorialClose" class="btn btn-secondary" style="position:absolute; right:15px; top:15px; z-index:1;">‚úñ</button>
      
      <div id="tutorialContent" style="flex:1; overflow-y:auto; min-height:0;">
        <!-- √âcran 1 -->
        <div class="tutorial-screen" data-screen="1" style="display:block;">
          <div style="text-align:center; margin-bottom: 25px;">
            <div style="font-size: 4rem; margin-bottom: 10px;">üöÄ</div>
            <h2 style="color: var(--neon-cyan); font-size: 1.8rem; margin: 0;">Bienvenue !</h2>
          </div>
          <p style="font-size: 1.1rem; line-height: 1.6; color: var(--text-primary);">
            <strong>Infiltration Spatiale</strong> est un jeu de d√©duction sociale o√π des <span style="color: var(--neon-red);">saboteurs</span> 
            tentent d'√©liminer les <span style="color: var(--neon-cyan);">astronautes</span> sans √™tre d√©couverts.
          </p>
          <p style="font-size: 1.05rem; line-height: 1.6; color: var(--text-secondary);">
            Le jeu alterne entre <strong>phases de nuit</strong> (actions secr√®tes) et <strong>phases de jour</strong> (discussions et votes).
          </p>
        </div>

        <!-- √âcran 2 -->
        <div class="tutorial-screen" data-screen="2" style="display:none;">
          <div style="text-align:center; margin-bottom: 25px;">
            <div style="font-size: 4rem; margin-bottom: 10px;">üåô</div>
            <h2 style="color: var(--neon-purple, var(--neon-cyan)); font-size: 1.8rem; margin: 0;">Phase de nuit</h2>
          </div>
          <ul style="font-size: 1.05rem; line-height: 1.8; color: var(--text-primary); padding-left: 25px;">
            <li><strong style="color: var(--neon-red);">Saboteurs</strong> : choisissent une victime (unanimit√© requise)</li>
            <li><strong style="color: var(--neon-cyan);">Officier Radar</strong> : inspecte un joueur (saboteur ou non ?)</li>
            <li><strong style="color: var(--neon-green);">Docteur Bio</strong> : peut sauver OU tuer (1 vie + 1 mort max)</li>
            <li><strong style="color: var(--neon-orange);">R√¥les sp√©ciaux</strong> : Cam√©l√©on, Agent IA, etc.</li>
          </ul>
        </div>

        <!-- √âcran 3 -->
        <div class="tutorial-screen" data-screen="3" style="display:none;">
          <div style="text-align:center; margin-bottom: 25px;">
            <div style="font-size: 4rem; margin-bottom: 10px;">‚òÄÔ∏è</div>
            <h2 style="color: var(--neon-orange); font-size: 1.8rem; margin: 0;">Phase de jour</h2>
          </div>
          <ul style="font-size: 1.05rem; line-height: 1.8; color: var(--text-primary); padding-left: 25px;">
            <li>Les r√©sultats de la nuit sont r√©v√©l√©s (qui est mort ?)</li>
            <li>Tous les joueurs vivants <strong>discutent</strong> et <strong>d√©battent</strong></li>
            <li>Un <strong>vote d'√©jection</strong> a lieu pour √©liminer un suspect</li>
            <li>Le <strong>Capitaine</strong> tranche en cas d'√©galit√©</li>
          </ul>
          <p style="margin-top: 15px; padding: 12px; background: rgba(255,165,0,0.15); border-left: 3px solid var(--neon-orange); border-radius: 8px; color: var(--text-secondary);">
            <strong>Astuce :</strong> Observez les comportements, cherchez les contradictions, et faites confiance √† votre instinct !
          </p>
        </div>

        <!-- √âcran 4 -->
        <div class="tutorial-screen" data-screen="4" style="display:none;">
          <div style="text-align:center; margin-bottom: 25px;">
            <div style="font-size: 4rem; margin-bottom: 10px;">üèÜ</div>
            <h2 style="color: var(--neon-green); font-size: 1.8rem; margin: 0;">Conditions de victoire</h2>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div style="padding: 15px; background: rgba(0,255,255,0.1); border: 2px solid var(--neon-cyan); border-radius: 12px;">
              <div style="font-size: 2rem; margin-bottom: 8px;">üë®‚ÄçüöÄ</div>
              <div style="color: var(--neon-cyan); font-weight: 800; margin-bottom: 5px;">Astronautes gagnent</div>
              <div style="font-size: 0.95rem; color: var(--text-secondary);">Tous les saboteurs sont √©limin√©s</div>
            </div>
            <div style="padding: 15px; background: rgba(255,7,58,0.1); border: 2px solid var(--neon-red); border-radius: 12px;">
              <div style="font-size: 2rem; margin-bottom: 8px;">‚öîÔ∏è</div>
              <div style="color: var(--neon-red); font-weight: 800; margin-bottom: 5px;">Saboteurs gagnent</div>
              <div style="font-size: 0.95rem; color: var(--text-secondary);">Nombre de saboteurs ‚â• astronautes</div>
            </div>
          </div>
          <p style="text-align: center; font-size: 1.1rem; color: var(--neon-green); font-weight: 800;">
            Pr√™t √† jouer ? Cr√©ez ou rejoignez une mission ! üöÄ
          </p>
        </div>
      </div>

      <!-- Navigation -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--neon-cyan); flex-shrink:0;">
        <button id="tutorialPrev" class="btn btn-secondary">‚Üê Pr√©c√©dent</button>
        <div style="display: flex; gap: 8px;">
          <div class="tutorial-dot" data-dot="1" style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-cyan); cursor: pointer;"></div>
          <div class="tutorial-dot" data-dot="2" style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-cyan); opacity: 0.3; cursor: pointer;"></div>
          <div class="tutorial-dot" data-dot="3" style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-cyan); opacity: 0.3; cursor: pointer;"></div>
          <div class="tutorial-dot" data-dot="4" style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-cyan); opacity: 0.3; cursor: pointer;"></div>
          <div class="tutorial-dot" data-dot="5" style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-cyan); opacity: 0.3; cursor: pointer;"></div>
          <div class="tutorial-dot" data-dot="6" style="width: 12px; height: 12px; border-radius: 50%; background: var(--neon-cyan); opacity: 0.3; cursor: pointer;"></div>
        </div>
        <button id="tutorialNext" class="btn btn-primary">Suivant ‚Üí</button>
      </div>

      <div style="text-align: center; margin-top: 10px; flex-shrink:0;">
        <label style="display: inline-flex; align-items: center; gap: 8px; cursor: pointer; color: #ccc; font-size: 0.95rem;">
          <input type="checkbox" id="tutorialDontShow" style="width: 18px; height: 18px; cursor: pointer;">
          <span>Ne plus afficher ce tutoriel</span>
        </label>
      </div>
    </div>
  </div>

  <!-- ============================= -->
  <!-- D4 ‚Äî Video Briefing Mode -->
  <!-- ============================= -->
  <link rel="stylesheet" href="video-tracks.css">
  <link rel="stylesheet" href="video-briefing.css">
  <!-- Daily Call Object API (required for Daily.createCallObject) -->
  <script src="https://unpkg.com/@daily-co/daily-js@0.60.0/dist/daily.js"></script>
  <script src="video-mode-controller.js"></script>
  <script src="video-tracks.js"></script>
  <script src="video-briefing-ui.js"></script>

  <!-- Boot: ensure Socket.IO client is available (works on Render + local; shows a clear error if server not running) -->
  <script>
    (function () {
      function loadScript(src) {
        return new Promise(function (resolve) {
          var s = document.createElement('script');
          s.src = src;
          s.async = true;
          s.onload = function () { resolve(true); };
          s.onerror = function () { resolve(false); };
          document.head.appendChild(s);
        });
      }

      function loadClient() {
        var s = document.createElement('script');
        s.src = 'client.js';
        s.async = true;
        document.body.appendChild(s);
      }

      function loadVideoManager() {
        // Charger le CSS d'abord
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'daily-video.css';
        document.head.appendChild(link);
        
        // Puis le JS
        var s = document.createElement('script');
        s.src = 'daily-video.js';
        s.async = true;
        document.body.appendChild(s);
      }

      function loadVideoIntegration() {
        var s = document.createElement('script');
        s.src = 'video-integration-client.js';
        s.async = true;
        document.body.appendChild(s);
      }

      // Try local first (Render/local). If not available (e.g., opened via file://), fallback to CDN
      loadScript('/socket.io/socket.io.js').then(function () {
        if (typeof window.io === 'undefined') {
          return loadScript('https://cdn.socket.io/4.7.5/socket.io.min.js');
        }
        return true;
      })
      .then(function() {
        // Charger Daily.co
        return loadScript('https://unpkg.com/@daily-co/daily-js@0.60.0/dist/daily-iframe.js');
      })
      .then(function() {
        // Charger le video manager
        loadVideoManager();
        // Charger le client principal
        loadClient();
        // Charger l'int√©gration vid√©o (apr√®s le client)
        setTimeout(loadVideoIntegration, 1000);
        
        // D7-D10: Charger les nouveaux modules
        setTimeout(function() {
          loadScript('d7-animations.js');
          loadScript('d8-performance.js');
          loadScript('d9-avatars.js');
          loadScript('d10-pwa.js');
        }, 1500);
      });
    })();
  </script>

  <!-- Script d'authentification et user bar -->
  <script>
    (function initAuth() {
      const isGuestMode = new URLSearchParams(window.location.search).get('mode') === 'guest';
      const token = localStorage.getItem('saboteur_token');
      const savedUser = localStorage.getItem('saboteur_user');

      // Injecter les styles pour la barre utilisateur
      const style = document.createElement('style');
      style.textContent = `
        .user-bar {
          position: fixed; top: 0; left: 0; right: 0; height: 52px;
          background: linear-gradient(180deg, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 100%);
          border-bottom: 2px solid var(--neon-cyan, #00ffff);
          display: flex; align-items: center; justify-content: space-between;
          padding: 0 15px; z-index: 10000;
          box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        .user-bar-left { display: flex; align-items: center; gap: 10px; }
        .user-bar-avatar {
          width: 36px; height: 36px; border-radius: 50%;
          border: 2px solid var(--neon-cyan, #00ffff); object-fit: cover;
        }
        .user-bar-name {
          font-family: 'Orbitron', sans-serif;
          color: var(--neon-cyan, #00ffff); font-size: 0.95rem; font-weight: 700;
        }
        .user-bar-credits {
          font-size: 0.8rem; color: #aaa;
          background: rgba(0,0,0,0.5); padding: 3px 10px;
          border-radius: 15px; border: 1px solid #333;
        }
        .user-bar-right { display: flex; align-items: center; gap: 8px; }
        .user-bar-btn {
          padding: 6px 12px; border-radius: 8px; font-size: 0.85rem;
          font-weight: 600; cursor: pointer;
          border: 1px solid var(--neon-cyan, #00ffff);
          background: transparent; color: var(--neon-cyan, #00ffff);
          transition: all 0.2s;
        }
        .user-bar-btn:hover { background: var(--neon-cyan, #00ffff); color: #000; }
        .user-bar-btn.logout { border-color: #ff073a; color: #ff073a; }
        .user-bar-btn.logout:hover { background: #ff073a; color: #fff; }
        .guest-banner {
          position: fixed; top: 52px; left: 0; right: 0;
          background: linear-gradient(90deg, rgba(255, 165, 0, 0.2) 0%, rgba(255, 165, 0, 0.1) 100%);
          border-bottom: 1px solid orange;
          padding: 8px 15px; text-align: center; z-index: 9999;
          font-size: 0.85rem; color: orange;
        }
        .guest-banner a { color: #00ffff; text-decoration: underline; cursor: pointer; }
        body { padding-top: 52px !important; }
        body.guest-mode { padding-top: 90px !important; }
        #topLeftButtons { top: 62px !important; }
        #topRightButtons { top: 62px !important; }
      `;
      document.head.appendChild(style);

      // Cr√©er la barre utilisateur (sans s√©lecteur de th√®me)
      const userBar = document.createElement('div');
      userBar.className = 'user-bar';
      userBar.innerHTML = `
        <div class="user-bar-left">
          <img src="/icons/icon-192x192.webp" alt="Avatar" class="user-bar-avatar" id="userBarAvatar">
          <span class="user-bar-name" id="userBarName">Invit√©</span>
          <span class="user-bar-credits" id="userBarCredits">Chat uniquement</span>
        </div>
        <div class="user-bar-right">
          <button class="user-bar-btn" onclick="window.location.href='/avatar.html'" id="avatarBtn" style="display:none;">üé® Avatar</button>
          <button class="user-bar-btn logout" onclick="logoutGame()">üö™ D√©connexion</button>
        </div>
      `;
      document.body.insertBefore(userBar, document.body.firstChild);
      
      // Style pour cacher les √©l√©ments
      const hideStyle = document.createElement('style');
      hideStyle.textContent = `
        /* Cacher le bouton avatar en bas √† droite */
        #customizationBtn {
          display: none !important;
        }
        /* Cacher le cadre TH√àME (H√îTE) dans le lobby */
        #themeSelector {
          display: none !important;
        }
        /* Cacher l'ancien s√©lecteur de th√®me de la page d'accueil game.html */
        #homeThemeSelector {
          display: none !important;
        }
      `;
      document.head.appendChild(hideStyle);
      
      // Fonction pour synchroniser le th√®me avec le serveur (pour les joueurs qui rejoignent)
      window.syncThemeWithServer = function() {
        const state = window.state;
        if (state && state.themeId) {
          localStorage.setItem('saboteur_theme', state.themeId);
          
          // Mettre √† jour homeSelectedTheme via window
          if (typeof window.homeSelectedTheme !== 'undefined') {
            window.homeSelectedTheme = state.themeId;
          }
          
          // Appliquer les styles et traductions
          if (typeof applyThemeStyles === 'function') {
            applyThemeStyles(state.themeId);
          } else {
            document.documentElement.setAttribute('data-theme', state.themeId);
          }
          if (typeof applyThemeTranslations === 'function') {
            applyThemeTranslations();
          }
          
          console.log('[Theme] Synchronis√© avec serveur:', state.themeId);
        }
      };
      
      // Appeler la synchronisation quand socket re√ßoit roomState
      window.addEventListener('load', function() {
        // Attendre que le socket soit pr√™t
        const checkSocket = setInterval(function() {
          if (window.socket) {
            clearInterval(checkSocket);
            
            // √âcouter roomState pour synchroniser le th√®me
            window.socket.on('roomState', function(state) {
              setTimeout(window.syncThemeWithServer, 100);
            });
            
            // En mode invit√©: intercepter les √©missions pour forcer chatOnly
            if (isGuestMode) {
              const originalEmit = window.socket.emit.bind(window.socket);
              window.socket.emit = function(event, data, cb) {
                if (event === 'createRoom' || event === 'joinRoom') {
                  data = { ...data, chatOnly: true, videoEnabled: false };
                  console.log('[Guest] Forcing chatOnly mode for', event);
                }
                return originalEmit(event, data, cb);
              };
              console.log('[Guest] Socket emit intercept√© pour forcer chatOnly');
            }
          }
        }, 100);
      });
      
      // En mode invit√©: forcer la checkbox vid√©o d√©sactiv√©e
      if (isGuestMode) {
        // Observer le DOM pour forcer la checkbox vid√©o
        const forceVideoDisabled = function() {
          const checkbox = document.getElementById('disableVideoCheckbox');
          if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
            checkbox.style.opacity = '0.6';
            checkbox.style.cursor = 'not-allowed';
            // Emp√™cher tout changement
            checkbox.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              this.checked = true;
              return false;
            });
          }
        };
        
        // Appliquer imm√©diatement et observer les changements du DOM
        forceVideoDisabled();
        const observer = new MutationObserver(forceVideoDisabled);
        observer.observe(document.body, { childList: true, subtree: true });
      }

      // Fonction de d√©connexion
      window.logoutGame = function() {
        localStorage.removeItem('saboteur_token');
        localStorage.removeItem('saboteur_user');
        sessionStorage.clear();
        window.location.href = '/';
      };

      if (isGuestMode) {
        // Mode invit√©
        document.body.classList.add('guest-mode');
        document.getElementById('userBarName').textContent = 'Invit√©';
        document.getElementById('userBarCredits').textContent = 'Chat uniquement';
        
        // Ajouter la banni√®re invit√©
        const banner = document.createElement('div');
        banner.className = 'guest-banner';
        banner.innerHTML = 'üë§ Mode Invit√© - Chat uniquement. <a href="/">Cr√©er un compte</a> pour acc√©der aux parties vid√©o !';
        document.body.insertBefore(banner, document.body.children[1]);

        // G√©n√©rer un nom al√©atoire pour l'invit√©
        setTimeout(function() {
          var playerNameInput = document.getElementById('playerName');
          if (playerNameInput && !playerNameInput.value) {
            var randomId = Math.floor(1000 + Math.random() * 9000);
            playerNameInput.value = 'Invit√©-' + randomId;
          }
        }, 100);
      } else if (token && savedUser) {
        // Utilisateur connect√©
        try {
          const user = JSON.parse(savedUser);
          document.getElementById('userBarName').textContent = user.username || 'Joueur';
          document.getElementById('avatarBtn').style.display = '';
          
          if (user.currentAvatar) {
            document.getElementById('userBarAvatar').src = user.currentAvatar;
          }
          
          // Afficher les cr√©dits vid√©o
          if (user.accountType === 'admin') {
            document.getElementById('userBarCredits').textContent = 'üé¨ Vid√©o illimit√©e';
          } else if (user.videoCredits === Infinity || user.videoCredits > 1000) {
            document.getElementById('userBarCredits').textContent = 'üé¨ Vid√©o illimit√©e';
          } else {
            document.getElementById('userBarCredits').textContent = 'üé¨ ' + (user.videoCredits || 0) + ' partie(s) vid√©o';
          }

          // Pr√©-remplir le nom du joueur IMM√âDIATEMENT
          setTimeout(function() {
            var playerNameInput = document.getElementById('playerName');
            if (playerNameInput && !playerNameInput.value) {
              playerNameInput.value = user.username;
            }
          }, 100);
        } catch (e) {
          console.error('Erreur parsing user:', e);
        }
      } else {
        // Pas de token et pas en mode invit√©, rediriger vers l'accueil
        window.location.href = '/';
      }

      // === APPLIQUER LE TH√àME ===
      // R√©cup√©rer le th√®me depuis l'URL ou localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const themeFromUrl = urlParams.get('theme');
      const themeFromStorage = localStorage.getItem('saboteur_theme');
      const currentTheme = themeFromUrl || themeFromStorage || 'default';
      
      // Appliquer le th√®me au document
      document.documentElement.setAttribute('data-theme', currentTheme);
      localStorage.setItem('saboteur_theme', currentTheme);
      console.log('[Auth] Th√®me appliqu√©:', currentTheme);

      // === CACHER LE BOUTON "VISIO ACTIV√âE" AU D√âMARRAGE ===
      setTimeout(function() {
        // Cacher le statut vid√©o en bas √† gauche (il appara√Ætra dans le lobby)
        const videoStatusElements = document.querySelectorAll('[id*="videoStatus"], [class*="video-status"]');
        videoStatusElements.forEach(function(el) {
          if (el.closest('#homeScreen')) {
            el.style.display = 'none';
          }
        });
        
        // Trouver et cacher l'indicateur "Visio activ√©e" sur l'√©cran d'accueil
        const visioIndicator = document.querySelector('#homeScreen [style*="Visio"]');
        if (visioIndicator) visioIndicator.style.display = 'none';
      }, 100);

      // === GESTION VID√âO POUR INVIT√âS / SANS CR√âDITS ===
      setTimeout(function() {
        const disableVideoCheckbox = document.getElementById('disableVideoCheckbox');
        if (!disableVideoCheckbox) return;

        const shouldDisableVideo = isGuestMode || 
          (savedUser && JSON.parse(savedUser).videoCredits <= 0 && JSON.parse(savedUser).accountType !== 'admin');

        if (shouldDisableVideo) {
          // Cocher et verrouiller la case "D√©sactiver la vid√©o"
          disableVideoCheckbox.checked = true;
          disableVideoCheckbox.disabled = true;
          disableVideoCheckbox.parentElement.style.opacity = '0.6';
          disableVideoCheckbox.parentElement.title = isGuestMode 
            ? 'Vid√©o non disponible en mode invit√©' 
            : 'Vous n\'avez plus de cr√©dits vid√©o';
          
          console.log('[Auth] Vid√©o d√©sactiv√©e automatiquement:', isGuestMode ? 'mode invit√©' : 'plus de cr√©dits');
        }
      }, 1000);
    })();
  </script>
</body>
</html>
