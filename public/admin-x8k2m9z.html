<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîê Admin Panel - Saboteur</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #00ffff;
    }
    
    /* Login Screen */
    #loginScreen {
      max-width: 400px;
      margin: 100px auto;
      background: rgba(0, 0, 0, 0.5);
      padding: 40px;
      border-radius: 15px;
      border: 2px solid #333;
    }
    
    #loginScreen h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #ff6600;
    }
    
    /* Admin Panel */
    #adminPanel {
      display: none;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-card .number {
      font-size: 2.5em;
      font-weight: bold;
      color: #00ffff;
    }
    
    .stat-card .label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9em;
    }
    
    .section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid #333;
    }
    
    .section h3 {
      margin-bottom: 20px;
      color: #00ff88;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    input, select {
      padding: 12px 15px;
      border: 1px solid #444;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      font-size: 1em;
      flex: 1;
      min-width: 150px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #00ffff;
    }
    
    button {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #00ffff, #0099cc);
      color: #000;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #00ff88, #00cc6a);
      color: #000;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #ff6600, #ff9900);
      color: #000;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ff4444, #cc0000);
      color: #fff;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Users Table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .users-table th, .users-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    
    .users-table th {
      background: rgba(0, 255, 255, 0.1);
      color: #00ffff;
    }
    
    .users-table tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .badge-admin { background: #ff6600; color: #000; }
    .badge-subscriber { background: #00ff88; color: #000; }
    .badge-pack { background: #00ffff; color: #000; }
    .badge-free { background: #666; color: #fff; }
    
    .verified { color: #00ff88; }
    .not-verified { color: #ff6666; }
    
    /* Result message */
    .result {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }
    
    .result.success {
      background: rgba(0, 255, 136, 0.2);
      border: 1px solid #00ff88;
      color: #00ff88;
    }
    
    .result.error {
      background: rgba(255, 68, 68, 0.2);
      border: 1px solid #ff4444;
      color: #ff4444;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .users-table {
        font-size: 0.85em;
      }
      
      .users-table th, .users-table td {
        padding: 8px;
      }
    }
    
    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
    }
    
    .action-btn {
      padding: 5px 10px;
      font-size: 0.8em;
      margin: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Login Screen -->
    <div id="loginScreen">
      <h2>üîê Admin Panel</h2>
      <input type="password" id="secretInput" placeholder="Code secret admin" onkeypress="if(event.key==='Enter') login()">
      <button class="btn-primary" style="width: 100%; margin-top: 15px;" onclick="login()">
        Acc√©der
      </button>
      <div id="loginResult" class="result"></div>
    </div>
    
    <!-- Admin Panel -->
    <div id="adminPanel">
      <button class="btn-danger logout-btn" onclick="logout()">üö™ D√©connexion</button>
      
      <h1>üîê Saboteur Admin Panel</h1>
      
      <!-- V35: Stats Serveur -->
      <div class="stats-grid" id="serverStatsGrid" style="margin-bottom: 20px; background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%); padding: 15px; border-radius: 12px;">
        <div class="stat-card" style="background: rgba(0,255,136,0.1); border-color: #00ff88;">
          <div class="number" id="statUptime" style="color: #00ff88;">-</div>
          <div class="label">‚è±Ô∏è Uptime</div>
        </div>
        <div class="stat-card" style="background: rgba(255,165,0,0.1); border-color: #ffa500;">
          <div class="number" id="statMemory" style="color: #ffa500;">-</div>
          <div class="label">üíæ M√©moire (MB)</div>
        </div>
        <div class="stat-card" style="background: rgba(0,255,255,0.1); border-color: #00ffff;">
          <div class="number" id="statRooms" style="color: #00ffff;">-</div>
          <div class="label">üö™ Rooms actives</div>
        </div>
        <div class="stat-card" style="background: rgba(255,0,255,0.1); border-color: #ff00ff;">
          <div class="number" id="statPlayers" style="color: #ff00ff;">-</div>
          <div class="label">üë• Joueurs connect√©s</div>
        </div>
      </div>
      
      <!-- Stats Utilisateurs -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="number" id="statTotal">-</div>
          <div class="label">Utilisateurs</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statVerified">-</div>
          <div class="label">V√©rifi√©s</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statSubscribers">-</div>
          <div class="label">Subscribers</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statPacks">-</div>
          <div class="label">Packs</div>
        </div>
        <div class="stat-card">
          <div class="number" id="statAdmins">-</div>
          <div class="label">Admins</div>
        </div>
      </div>
      
      <!-- Upgrade User -->
      <div class="section">
        <h3>‚¨ÜÔ∏è Upgrade / Modifier un compte</h3>
        <div class="form-row">
          <input type="email" id="upgradeEmail" placeholder="Email de l'utilisateur">
          <select id="upgradeTier">
            <option value="free">Free (2 cr√©dits)</option>
            <option value="pack">Pack (50 cr√©dits)</option>
            <option value="subscriber">Subscriber (illimit√©)</option>
            <option value="admin">Admin (illimit√©)</option>
          </select>
          <button class="btn-success" onclick="upgradeUser()">Appliquer</button>
        </div>
        <div id="upgradeResult" class="result"></div>
      </div>
      
      <!-- Add Credits -->
      <div class="section">
        <h3>üéÅ Ajouter des cr√©dits</h3>
        <div class="form-row">
          <input type="email" id="creditsEmail" placeholder="Email de l'utilisateur">
          <input type="number" id="creditsAmount" placeholder="Nombre de cr√©dits" value="50" min="1">
          <button class="btn-warning" onclick="addCredits()">Ajouter</button>
        </div>
        <div id="creditsResult" class="result"></div>
      </div>
      
      <!-- Delete User -->
      <div class="section">
        <h3>üóëÔ∏è Supprimer un compte</h3>
        <div class="form-row">
          <input type="email" id="deleteEmail" placeholder="Email de l'utilisateur">
          <button class="btn-danger" onclick="deleteUser()">Supprimer</button>
        </div>
        <div id="deleteResult" class="result"></div>
      </div>
      
      <!-- V35: Reset User Avatars/Video -->
      <div class="section">
        <h3>üîÑ Reset Joueur (Tests)</h3>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">Remet √† z√©ro les compteurs d'un joueur pour les tests</p>
        <div class="form-group">
          <label>ID Utilisateur</label>
          <input type="number" id="resetUserId" placeholder="ID du joueur">
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="resetAvatarsCheck" checked> Reset compteur avatars
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="resetVideoCheck"> Reset cr√©dits vid√©o
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="deleteAvatarFilesCheck"> Supprimer fichiers avatars
          </label>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ff6b6b;">
            <input type="checkbox" id="removeFromFamilyCheck"> ‚ö†Ô∏è Retirer du pack famille
          </label>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: #ff6b6b;">
            <input type="checkbox" id="downgradeToFreeCheck"> ‚ö†Ô∏è Downgrade en FREE (reset complet)
          </label>
        </div>
        <button class="btn-warning" onclick="resetUser()">üîÑ Reset le joueur</button>
        <div id="resetUserResult" class="result"></div>
      </div>
      
      <!-- Clear IP Logs -->
      <div class="section">
        <h3>üîì Reset limites IP</h3>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px;">Efface les limitations de cr√©ation de compte par IP</p>
        <button class="btn-warning" onclick="clearIpLogs()">Reset limites IP</button>
        <div id="ipResult" class="result"></div>
      </div>
      
      <!-- Users List -->
      <div class="section">
        <h3>üìã Liste des utilisateurs</h3>
        <button class="btn-primary" onclick="loadUsers()">üîÑ Rafra√Æchir la liste</button>
        <div style="overflow-x: auto;">
          <table class="users-table" id="usersTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Pseudo</th>
                <th>Type</th>
                <th>V√©rifi√©</th>
                <th>Cr√©dits</th>
                <th>Inscrit le</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersBody">
              <tr><td colspan="8" style="text-align: center; color: #666;">Clique sur "Rafra√Æchir" pour charger</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
    </div>
  </div>
  
  <script>
    let adminSecret = '';
    
    function login() {
      adminSecret = document.getElementById('secretInput').value;
      
      if (!adminSecret) {
        showResult('loginResult', 'Code secret requis', false);
        return;
      }
      
      // Test avec l'API stats
      fetch(`/api/admin/stats?secretCode=${encodeURIComponent(adminSecret)}`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadStats();
            loadUsers();
            // V35: Auto-refresh stats serveur toutes les 30 secondes
            if (!window.statsInterval) {
              window.statsInterval = setInterval(loadStats, 30000);
            }
          } else {
            showResult('loginResult', data.error || 'Code invalide', false);
          }
        })
        .catch(err => {
          showResult('loginResult', 'Erreur de connexion', false);
        });
    }
    
    function logout() {
      adminSecret = '';
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('secretInput').value = '';
    }
    
    function showResult(elementId, message, success) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'result ' + (success ? 'success' : 'error');
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }
    
    function loadStats() {
      fetch(`/api/admin/stats?secretCode=${encodeURIComponent(adminSecret)}`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            // Stats utilisateurs
            document.getElementById('statTotal').textContent = data.stats.totalUsers;
            document.getElementById('statVerified').textContent = data.stats.verifiedUsers;
            document.getElementById('statSubscribers').textContent = data.stats.subscribers;
            document.getElementById('statPacks').textContent = data.stats.packs;
            document.getElementById('statAdmins').textContent = data.stats.admins;
            
            // V35: Stats serveur
            if (data.server) {
              document.getElementById('statUptime').textContent = data.server.uptime;
              document.getElementById('statMemory').textContent = `${data.server.memory.heapUsed}/${data.server.memory.heapTotal}`;
              document.getElementById('statRooms').textContent = data.server.activeRooms;
              document.getElementById('statPlayers').textContent = `${data.server.playersInGame}/${data.server.totalPlayers}`;
            }
          }
        });
    }
    
    function loadUsers() {
      fetch(`/api/admin/users?secretCode=${encodeURIComponent(adminSecret)}`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            const tbody = document.getElementById('usersBody');
            if (data.users.length === 0) {
              tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Aucun utilisateur</td></tr>';
              return;
            }
            
            tbody.innerHTML = data.users.map(u => `
              <tr>
                <td>${u.id}</td>
                <td>${u.email}</td>
                <td>${u.username}</td>
                <td><span class="badge badge-${u.account_type}">${u.account_type}</span></td>
                <td class="${u.email_verified ? 'verified' : 'not-verified'}">${u.email_verified ? '‚úÖ' : '‚ùå'}</td>
                <td>${u.video_credits === 999999 ? '‚àû' : u.video_credits}</td>
                <td>${new Date(u.created_at).toLocaleDateString('fr-FR')}</td>
                <td>
                  <button class="btn-success action-btn" onclick="quickUpgrade('${u.email}', 'subscriber')">Sub</button>
                  <button class="btn-danger action-btn" onclick="quickDelete('${u.email}')">üóëÔ∏è</button>
                </td>
              </tr>
            `).join('');
          }
        });
    }
    
    function upgradeUser() {
      const email = document.getElementById('upgradeEmail').value;
      const tier = document.getElementById('upgradeTier').value;
      
      if (!email) {
        showResult('upgradeResult', 'Email requis', false);
        return;
      }
      
      fetch('/api/admin/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, tier, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('upgradeResult', data.message || data.error, data.ok);
          if (data.ok) {
            loadStats();
            loadUsers();
            document.getElementById('upgradeEmail').value = '';
          }
        });
    }
    
    function addCredits() {
      const email = document.getElementById('creditsEmail').value;
      const credits = document.getElementById('creditsAmount').value;
      
      if (!email || !credits) {
        showResult('creditsResult', 'Email et cr√©dits requis', false);
        return;
      }
      
      fetch('/api/admin/add-credits', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, credits: parseInt(credits), secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('creditsResult', data.message || data.error, data.ok);
          if (data.ok) {
            loadUsers();
            document.getElementById('creditsEmail').value = '';
          }
        });
    }
    
    function deleteUser() {
      const email = document.getElementById('deleteEmail').value;
      
      if (!email) {
        showResult('deleteResult', 'Email requis', false);
        return;
      }
      
      if (!confirm(`Supprimer d√©finitivement ${email} ?`)) return;
      
      fetch('/api/admin/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('deleteResult', data.message || data.error, data.ok);
          if (data.ok) {
            loadStats();
            loadUsers();
            document.getElementById('deleteEmail').value = '';
          }
        });
    }
    
    // V35: Reset user avatars/video
    function resetUser() {
      const userId = document.getElementById('resetUserId').value;
      if (!userId) {
        showResult('resetUserResult', 'ID utilisateur requis', false);
        return;
      }
      
      const resetAvatars = document.getElementById('resetAvatarsCheck').checked;
      const resetVideo = document.getElementById('resetVideoCheck').checked;
      const deleteAvatarFiles = document.getElementById('deleteAvatarFilesCheck').checked;
      const removeFromFamily = document.getElementById('removeFromFamilyCheck').checked;
      const downgradeToFree = document.getElementById('downgradeToFreeCheck').checked;
      
      if (!resetAvatars && !resetVideo && !deleteAvatarFiles && !removeFromFamily && !downgradeToFree) {
        showResult('resetUserResult', 'S√©lectionne au moins une option', false);
        return;
      }
      
      let confirmMsg = `Reset pour user #${userId} :\n`;
      if (downgradeToFree) confirmMsg += '‚ö†Ô∏è DOWNGRADE EN FREE (reset complet)\n';
      if (removeFromFamily) confirmMsg += '‚ö†Ô∏è Retrait du pack famille\n';
      if (resetAvatars) confirmMsg += '- Compteur avatars √† 0\n';
      if (resetVideo) confirmMsg += '- Cr√©dits vid√©o r√©initialis√©s\n';
      if (deleteAvatarFiles) confirmMsg += '- SUPPRESSION des fichiers avatars\n';
      
      if (!confirm(confirmMsg + '\nConfirmer ?')) return;
      
      fetch('/api/admin/reset-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          userId: parseInt(userId), 
          resetAvatars, 
          resetVideo, 
          deleteAvatarFiles,
          removeFromFamily,
          downgradeToFree,
          secretCode: adminSecret 
        })
      })
        .then(r => r.json())
        .then(data => {
          showResult('resetUserResult', data.message || data.error, data.ok);
          if (data.ok) loadUsers();
        });
    }

    function clearIpLogs() {
      if (!confirm('Effacer toutes les limites IP ?')) return;
      
      fetch('/api/admin/clear-ip-logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          showResult('ipResult', data.message || data.error, data.ok);
        });
    }
    
    function quickUpgrade(email, tier) {
      if (!confirm(`Passer ${email} en ${tier} ?`)) return;
      
      fetch('/api/admin/upgrade', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, tier, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            loadStats();
            loadUsers();
          } else {
            alert(data.error);
          }
        });
    }
    
    function quickDelete(email) {
      if (!confirm(`Supprimer d√©finitivement ${email} ?`)) return;
      
      fetch('/api/admin/delete-user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, secretCode: adminSecret })
      })
        .then(r => r.json())
        .then(data => {
          if (data.ok) {
            loadStats();
            loadUsers();
          } else {
            alert(data.error);
          }
        });
    }
  </script>
</body>
</html>
