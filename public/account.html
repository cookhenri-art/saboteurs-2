<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mon Compte - RORONOA GAMES</title>
  <link rel="icon" href="data:,">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Couleurs Roronoa Games - Style Zoro */
      --green-dark: #2D5016;
      --green-main: #4A7C28;
      --green-bright: #6B9D3A;
      --green-glow: rgba(107, 157, 58, 0.3);
      
      --gold: #FFD700;
      --gold-dark: #FFA500;
      --black: #000000;
      --dark: #0a0a0a;
      --darker: #151515;
      --gray: #333;
      --light-gray: #666;
      --white: #ffffff;
      --off-white: #f5f5f5;
      
      --danger: #e74c3c;
      --danger-dark: #c0392b;
      --success: #27ae60;
      
      --font-title: 'Orbitron', sans-serif;
      --font-text: 'Rajdhani', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: var(--font-text);
      background: var(--black);
      color: var(--white);
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* ========================================
       HEADER
       ======================================== */
    
    .header {
      background: rgba(0, 0, 0, 0.95);
      border-bottom: 2px solid var(--green-main);
      box-shadow: 0 0 20px var(--green-glow);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-family: var(--font-title);
      font-size: 1.5rem;
      font-weight: 900;
      color: var(--white);
      letter-spacing: 2px;
      text-decoration: none;
    }
    
    .logo-accent {
      color: var(--green-bright);
    }
    
    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .btn-header {
      background: transparent;
      border: 2px solid var(--green-main);
      color: var(--green-bright);
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-family: var(--font-text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    
    .btn-header:hover {
      background: var(--green-main);
      color: var(--white);
      transform: translateY(-2px);
    }
    
    .btn-logout {
      border-color: var(--danger);
      color: var(--danger);
    }
    
    .btn-logout:hover {
      background: var(--danger);
      color: var(--white);
    }
    
    /* ========================================
       MAIN CONTAINER
       ======================================== */
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .page-title {
      font-family: var(--font-title);
      font-size: 2.5rem;
      color: var(--green-bright);
      margin-bottom: 0.5rem;
      text-shadow: 0 0 20px var(--green-glow);
    }
    
    .page-subtitle {
      color: var(--light-gray);
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }
    
    .page-subtitle strong {
      color: var(--green-bright);
    }
    
    /* ========================================
       TABS
       ======================================== */
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      border-bottom: 2px solid var(--gray);
      padding-bottom: 1rem;
    }
    
    .tab {
      background: transparent;
      border: none;
      color: var(--light-gray);
      padding: 1rem 1.5rem;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      transition: all 0.3s;
      font-family: var(--font-text);
      font-size: 1rem;
      font-weight: 600;
      position: relative;
    }
    
    .tab:hover {
      color: var(--green-bright);
      background: rgba(107, 157, 58, 0.1);
    }
    
    .tab.active {
      color: var(--green-bright);
      background: rgba(107, 157, 58, 0.15);
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--green-bright);
      border-radius: 2px;
    }
    
    /* ========================================
       SECTIONS
       ======================================== */
    
    .section {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ========================================
       CARDS
       ======================================== */
    
    .card {
      background: linear-gradient(135deg, rgba(45, 80, 22, 0.1) 0%, rgba(74, 124, 40, 0.1) 100%);
      border: 1px solid rgba(107, 157, 58, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(107, 157, 58, 0.2);
    }
    
    .card-title {
      font-family: var(--font-title);
      font-size: 1.3rem;
      color: var(--green-bright);
    }
    
    /* ========================================
       FORMS
       ======================================== */
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--off-white);
      font-weight: 600;
    }
    
    .input-wrapper {
      position: relative;
    }
    
    .form-group input {
      width: 100%;
      padding: 1rem;
      padding-right: 3rem;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--gray);
      border-radius: 8px;
      color: var(--white);
      font-family: var(--font-text);
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: var(--green-bright);
      box-shadow: 0 0 10px var(--green-glow);
    }
    
    .form-group input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(0, 0, 0, 0.3);
    }
    
    .toggle-password {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--light-gray);
      cursor: pointer;
      font-size: 1.2rem;
      transition: color 0.3s;
    }
    
    .toggle-password:hover {
      color: var(--green-bright);
    }
    
    /* ========================================
       BUTTONS
       ======================================== */
    
    .btn {
      background: linear-gradient(135deg, var(--green-main) 0%, var(--green-bright) 100%);
      border: none;
      color: var(--white);
      padding: 1rem 2rem;
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font-text);
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px var(--green-glow);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: transparent;
      border: 2px solid var(--green-main);
      color: var(--green-bright);
    }
    
    .btn-secondary:hover {
      background: var(--green-main);
      color: var(--white);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
    }
    
    .btn-danger:hover {
      box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
    }
    
    .btn-gold {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: var(--black);
    }
    
    .btn-gold:hover {
      box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
    }
    
    .btn-small {
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
    }
    
    /* ========================================
       SUBSCRIPTION CARDS
       ======================================== */
    
    .subscription-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .subscription-card {
      background: linear-gradient(135deg, rgba(45, 80, 22, 0.15) 0%, rgba(74, 124, 40, 0.15) 100%);
      border: 2px solid rgba(107, 157, 58, 0.3);
      border-radius: 16px;
      padding: 2rem;
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    
    .subscription-card:hover {
      transform: translateY(-5px);
      border-color: var(--green-bright);
      box-shadow: 0 10px 30px var(--green-glow);
    }
    
    .subscription-card.active {
      border-color: var(--green-bright);
      box-shadow: 0 0 30px var(--green-glow);
    }
    
    .subscription-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--green-bright);
      color: var(--white);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
    }
    
    .subscription-badge.inactive {
      background: var(--gray);
    }
    
    .subscription-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .subscription-name {
      font-family: var(--font-title);
      font-size: 1.5rem;
      color: var(--green-bright);
      margin-bottom: 0.5rem;
    }
    
    .subscription-price {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 1rem;
    }
    
    .subscription-price span {
      font-size: 1rem;
      color: var(--light-gray);
    }
    
    .subscription-features {
      list-style: none;
      margin-bottom: 1.5rem;
    }
    
    .subscription-features li {
      padding: 0.5rem 0;
      color: var(--off-white);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .subscription-features li::before {
      content: "‚öîÔ∏è";
      font-size: 0.9rem;
    }
    
    .subscription-dates {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }
    
    .subscription-dates p {
      margin-bottom: 0.4rem;
      color: var(--light-gray);
    }
    
    .subscription-dates strong {
      color: var(--green-bright);
    }
    
    .subscription-actions {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    /* ========================================
       STATS GRID
       ======================================== */
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(45, 80, 22, 0.2) 0%, rgba(74, 124, 40, 0.2) 100%);
      border: 1px solid rgba(107, 157, 58, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
    }
    
    .stat-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-value {
      font-family: var(--font-title);
      font-size: 2rem;
      color: var(--green-bright);
      font-weight: 700;
    }
    
    .stat-label {
      color: var(--light-gray);
      font-size: 0.9rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--gray);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green-main), var(--green-bright));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    /* ========================================
       HISTORY TABLE
       ======================================== */
    
    .table-container {
      overflow-x: auto;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }
    
    .history-table th,
    .history-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--gray);
    }
    
    .history-table th {
      background: rgba(107, 157, 58, 0.1);
      color: var(--green-bright);
      font-weight: 700;
      white-space: nowrap;
    }
    
    .history-table tr:hover {
      background: rgba(107, 157, 58, 0.05);
    }
    
    .invoice-link {
      color: var(--green-bright);
      text-decoration: none;
      font-weight: 600;
    }
    
    .invoice-link:hover {
      color: var(--gold);
      text-decoration: underline;
    }
    
    /* ========================================
       ALERTS
       ======================================== */
    
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      animation: fadeIn 0.3s;
    }
    
    .alert-success {
      background: rgba(39, 174, 96, 0.2);
      border: 1px solid var(--success);
      color: var(--success);
    }
    
    .alert-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid var(--danger);
      color: var(--danger);
    }
    
    /* ========================================
       EMPTY STATE
       ======================================== */
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--light-gray);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* ========================================
       LOADER
       ======================================== */
    
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 3rem;
    }
    
    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--gray);
      border-top-color: var(--green-bright);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ========================================
       FAMILY CODE
       ======================================== */
    
    .family-code-box {
      background: rgba(255, 215, 0, 0.1);
      border: 2px dashed var(--gold);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      margin-top: 1rem;
    }
    
    .family-code-label {
      font-size: 0.9rem;
      color: var(--light-gray);
      margin-bottom: 0.5rem;
    }
    
    .family-code-value {
      font-family: var(--font-title);
      font-size: 1.5rem;
      color: var(--gold);
      letter-spacing: 2px;
    }
    
    /* ========================================
       GALERIE AVATARS
       ======================================== */
    
    .avatars-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }
    
    .avatar-item {
      position: relative;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid rgba(107, 157, 58, 0.3);
      transition: all 0.3s ease;
    }
    
    .avatar-item:hover {
      transform: translateY(-5px);
      border-color: var(--accent);
      box-shadow: 0 10px 30px rgba(107, 157, 58, 0.3);
    }
    
    .avatar-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
    }
    
    .avatar-actions {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 0.5rem;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .avatar-item:hover .avatar-actions {
      opacity: 1;
    }
    
    .avatar-btn {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .avatar-btn-download {
      background: var(--accent);
      color: #fff;
    }
    
    .avatar-btn-download:hover {
      background: #5a8a2f;
    }
    
    .avatar-date {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      background: rgba(0, 0, 0, 0.7);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      color: #aaa;
    }
    
    .loading-spinner {
      text-align: center;
      padding: 2rem;
      color: #888;
    }
    
    /* ========================================
       RESPONSIVE
       ======================================== */
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .page-title {
        font-size: 1.8rem;
      }
      
      .page-subtitle {
        font-size: 1rem;
      }
      
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        justify-content: center;
      }
      
      .tab {
        padding: 0.6rem 0.8rem;
        font-size: 0.8rem;
        flex: 1 1 auto;
        min-width: fit-content;
      }
      
      .subscription-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }
      
      .header-actions {
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.5rem;
      }
      
      .btn-header {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
      }
      
      .card {
        padding: 1.5rem;
      }
      
      .form-group input {
        padding: 0.8rem;
      }
      
      .avatars-gallery {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 0.5rem;
      }
      
      .avatar-actions {
        opacity: 1;
        padding: 0.3rem;
      }
      
      .avatar-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.75rem;
      }
      
      .subscription-card {
        padding: 1.5rem;
      }
    }
    
    @media (max-width: 480px) {
      .page-title {
        font-size: 1.5rem;
      }
      
      .tabs {
        gap: 0.2rem;
      }
      
      .tab {
        padding: 0.5rem 0.6rem;
        font-size: 0.75rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .avatars-gallery {
        grid-template-columns: repeat(2, 1fr);
      }
    }
      
      .tabs {
        gap: 0.25rem;
      }
      
      .tab {
        padding: 0.8rem 1rem;
        font-size: 0.9rem;
      }
      
      .subscription-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }
      
      .header-actions {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">RORONOA <span class="logo-accent">GAMES</span></a>
      <div class="header-actions">
        <a href="/" class="btn-header">‚öîÔ∏è Accueil</a>
        <a href="/index.html" target="_blank" class="btn-header">üéÆ Jouer</a>
        <button class="btn-header btn-logout" onclick="logout()">üö™ D√©connexion</button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <h1 class="page-title">‚öîÔ∏è Mon Compte</h1>
    <p class="page-subtitle">Bienvenue, <strong id="user-name">Chargement...</strong></p>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showSection('profile', this)">üë§ Profil</button>
      <button class="tab" onclick="showSection('avatars', this)">üé® Avatars</button>
      <button class="tab" onclick="showSection('subscriptions', this)">üíé Abonnements</button>
      <button class="tab" onclick="showSection('credits', this)">üì¶ Cr√©dits</button>
      <button class="tab" onclick="showSection('history', this)">üìú Historique</button>
    </div>
    
    <!-- ==========================================
         SECTION: PROFIL
         ========================================== -->
    <div id="section-profile" class="section active">
      <!-- Infos utilisateur -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üë§ Informations personnelles</h2>
        </div>
        
        <div id="alert-profile"></div>
        
        <form onsubmit="updateProfile(event)">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="profile-email" disabled>
          </div>
          
          <div class="form-group">
            <label>Pseudo</label>
            <input type="text" id="profile-username" required>
          </div>
          
          <div class="form-group">
            <label>Type de compte</label>
            <input type="text" id="profile-type" disabled>
          </div>
          
          <button type="submit" class="btn">üíæ Sauvegarder</button>
        </form>
      </div>
      
      <!-- Changer mot de passe -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üîí Changer le mot de passe</h2>
        </div>
        
        <div id="alert-password"></div>
        
        <form id="form-password" onsubmit="updatePassword(event)">
          <div class="form-group">
            <label>Mot de passe actuel</label>
            <div class="input-wrapper">
              <input type="password" id="current-password" required>
              <button type="button" class="toggle-password" onclick="togglePassword('current-password', this)">üëÅÔ∏è</button>
            </div>
          </div>
          
          <div class="form-group">
            <label>Nouveau mot de passe</label>
            <div class="input-wrapper">
              <input type="password" id="new-password" required minlength="6">
              <button type="button" class="toggle-password" onclick="togglePassword('new-password', this)">üëÅÔ∏è</button>
            </div>
          </div>
          
          <div class="form-group">
            <label>Confirmer le nouveau mot de passe</label>
            <div class="input-wrapper">
              <input type="password" id="confirm-password" required minlength="6">
              <button type="button" class="toggle-password" onclick="togglePassword('confirm-password', this)">üëÅÔ∏è</button>
            </div>
          </div>
          
          <button type="submit" class="btn">üîê Modifier le mot de passe</button>
        </form>
      </div>
    </div>
    
    <!-- ==========================================
         SECTION: MES AVATARS
         ========================================== -->
    <div id="section-avatars" class="section">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üé® Mes Avatars IA</h2>
          <span class="credits-badge" id="avatar-count-badge">0 avatars</span>
        </div>
        
        <p style="color: #aaa; margin-bottom: 1.5rem;">
          Vos avatars g√©n√©r√©s par IA sont disponibles ici. Vous pouvez les t√©l√©charger pour les utiliser dans d'autres jeux ou applications.
        </p>
        
        <div id="avatars-gallery" class="avatars-gallery">
          <div class="loading-spinner">Chargement...</div>
        </div>
        
        <div id="no-avatars" style="display: none; text-align: center; padding: 3rem; color: #888;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">üé®</div>
          <p>Vous n'avez pas encore d'avatar.</p>
          <p style="margin-top: 0.5rem;">
            <a href="/index.html" target="_blank" style="color: #6B9D3A;">Cr√©ez votre premier avatar dans le jeu ‚Üí</a>
          </p>
        </div>
      </div>
    </div>
    
    <!-- ==========================================
         SECTION: ABONNEMENTS
         ========================================== -->
    <div id="section-subscriptions" class="section">
      <div class="subscription-grid">
        <!-- Premium -->
        <div class="subscription-card" id="card-premium">
          <span class="subscription-badge inactive" id="premium-badge">Non actif</span>
          <div class="subscription-icon">‚öîÔ∏è</div>
          <h3 class="subscription-name">Pack Premium</h3>
          <div class="subscription-price">1,49‚Ç¨ <span>/mois</span></div>
          <ul class="subscription-features">
            <li>Vid√©o illimit√©e</li>
            <li>30 avatars IA / mois</li>
            <li>Tous les th√®mes</li>
            <li>Badge Premium</li>
            <li>Support prioritaire</li>
          </ul>
          
          <div class="subscription-dates" id="premium-dates" style="display: none;">
            <p>üìÖ D√©but : <strong id="premium-start">-</strong></p>
            <p>üîÑ Prochain pr√©l√®vement : <strong id="premium-next">-</strong></p>
            <p>üìä Statut : <strong id="premium-status-text">Actif</strong></p>
          </div>
          
          <div class="subscription-actions">
            <button class="btn" id="btn-premium" onclick="managePremium()">S'abonner</button>
            <button class="btn btn-danger btn-small" id="btn-cancel-premium" style="display: none;" onclick="cancelSubscription('premium')">‚ùå R√©silier l'abonnement</button>
          </div>
        </div>
        
        <!-- Pack Famille -->
        <div class="subscription-card" id="card-family">
          <span class="subscription-badge inactive" id="family-badge">Non actif</span>
          <div class="subscription-icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
          <h3 class="subscription-name">Pack Famille</h3>
          <div class="subscription-price">9,99‚Ç¨ <span>/mois</span></div>
          <ul class="subscription-features">
            <li>Jusqu'√† 8 comptes</li>
            <li>Vid√©o illimit√©e pour tous</li>
            <li>30 avatars IA / mois chacun</li>
            <li>Tous les th√®mes</li>
            <li>Gestion des membres</li>
          </ul>
          
          <div class="subscription-dates" id="family-dates" style="display: none;">
            <p>üìÖ D√©but : <strong id="family-start">-</strong></p>
            <p>üîÑ Prochain pr√©l√®vement : <strong id="family-next">-</strong></p>
            <p>üìä Statut : <strong id="family-status-text">Actif</strong></p>
          </div>
          
          <div id="family-code-section" style="display: none;">
            <div class="family-code-box">
              <p class="family-code-label">Code famille √† partager :</p>
              <p class="family-code-value" id="family-code">-</p>
            </div>
          </div>
          
          <div class="subscription-actions" style="margin-top: 1rem;">
            <button class="btn btn-gold" id="btn-family" onclick="manageFamily()">S'abonner</button>
            <button class="btn btn-danger btn-small" id="btn-cancel-family" style="display: none;" onclick="cancelSubscription('family')">‚ùå R√©silier l'abonnement</button>
          </div>
        </div>
      </div>
      
      <!-- Portail de paiement -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã G√©rer mes paiements</h2>
        </div>
        <p style="color: var(--light-gray); margin-bottom: 1rem;">
          Acc√©dez au portail Stripe pour modifier votre moyen de paiement, t√©l√©charger vos factures ou g√©rer votre abonnement.
        </p>
        <button class="btn btn-secondary" onclick="openBillingPortal()">üîó Acc√©der au portail de paiement</button>
      </div>
    </div>
    
    <!-- ==========================================
         SECTION: CR√âDITS & PACKS
         ========================================== -->
    <div id="section-credits" class="section">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üé¨</div>
          <div class="stat-value" id="video-credits">0</div>
          <div class="stat-label">Cr√©dits Vid√©o</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üé®</div>
          <div class="stat-value" id="bonus-avatars">0</div>
          <div class="stat-label">Avatars Bonus</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-value" id="monthly-avatars">0/2</div>
          <div class="stat-label">Avatars ce mois</div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-avatars" style="width: 0%"></div>
          </div>
        </div>
      </div>
      
      <!-- Pack 50+50 -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üéÅ Pack 50+50</h2>
        </div>
        <p style="color: var(--light-gray); margin-bottom: 1rem;">
          Achat unique : <strong style="color: var(--green-bright);">50 cr√©dits vid√©o</strong> + <strong style="color: var(--green-bright);">50 avatars bonus</strong>
        </p>
        <p style="margin-bottom: 1rem; font-size: 0.95rem; color: var(--off-white);">
          Id√©al pour compl√©ter votre abonnement ou offrir en cadeau !
        </p>
        <div class="subscription-price" style="margin-bottom: 1rem;">4,99‚Ç¨ <span>unique</span></div>
        <button class="btn btn-gold" onclick="buyPack()">üõí Acheter le Pack</button>
      </div>
    </div>
    
    <!-- ==========================================
         SECTION: HISTORIQUE
         ========================================== -->
    <div id="section-history" class="section">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìú Historique des achats</h2>
        </div>
        <div id="history-content">
          <div class="loader">
            <div class="loader-spinner"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURATION
    // ==========================================
    
    const TOKEN_KEY = 'saboteur_token';
    const USER_KEY = 'saboteur_user';
    let currentUser = null;
    
    // ==========================================
    // INIT
    // ==========================================
    
    async function init() {
      const token = localStorage.getItem(TOKEN_KEY) || localStorage.getItem('token');
      
      if (!token) {
        // Rediriger vers la page d'accueil si pas connect√©
        alert('Vous devez √™tre connect√© pour acc√©der √† cette page.');
        window.location.href = '/?login=required';
        return;
      }
      
      await loadUserData();
    }
    
    async function loadUserData() {
      try {
        const token = localStorage.getItem(TOKEN_KEY) || localStorage.getItem('token');
        const response = await fetch('/api/account/profile', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            alert('Session expir√©e. Veuillez vous reconnecter.');
            logout();
            return;
          }
          throw new Error('Erreur chargement profil');
        }
        
        currentUser = await response.json();
        console.log('User data loaded:', currentUser);
        
        // Mettre √† jour l'interface
        updateProfileUI();
        updateSubscriptionsUI();
        updateCreditsUI();
        
      } catch (error) {
        console.error('Erreur:', error);
        showAlert('alert-profile', '‚ùå Erreur de chargement du profil', 'error');
      }
    }
    
    // ==========================================
    // UI UPDATES
    // ==========================================
    
    function updateProfileUI() {
      if (!currentUser) return;
      
      document.getElementById('user-name').textContent = currentUser.username || 'Utilisateur';
      document.getElementById('profile-email').value = currentUser.email || '';
      document.getElementById('profile-username').value = currentUser.username || '';
      
      // Type de compte lisible
      const typeLabels = {
        'free': 'üÜì Gratuit',
        'subscriber': '‚öîÔ∏è Premium',
        'family': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famille',
        'pack': 'üì¶ Pack',
        'admin': 'üëë Administrateur',
        'client_site': 'üåê Client Site'
      };
      document.getElementById('profile-type').value = typeLabels[currentUser.account_type] || currentUser.account_type || 'Gratuit';
    }
    
    function updateSubscriptionsUI() {
      if (!currentUser) return;
      
      const accountType = currentUser.account_type || 'free';
      
      // Premium
      if (accountType === 'subscriber' || accountType === 'admin') {
        document.getElementById('card-premium').classList.add('active');
        document.getElementById('premium-badge').textContent = '‚úì ACTIF';
        document.getElementById('premium-badge').classList.remove('inactive');
        document.getElementById('btn-premium').textContent = '‚öôÔ∏è G√©rer l\'abonnement';
        document.getElementById('btn-cancel-premium').style.display = 'block';
        document.getElementById('premium-dates').style.display = 'block';
        
        if (currentUser.subscription_start) {
          document.getElementById('premium-start').textContent = formatDate(currentUser.subscription_start);
        } else {
          document.getElementById('premium-start').textContent = 'Non disponible';
        }
        
        if (currentUser.subscription_next || currentUser.current_period_end) {
          document.getElementById('premium-next').textContent = formatDate(currentUser.subscription_next || currentUser.current_period_end);
        } else {
          document.getElementById('premium-next').textContent = 'Non disponible';
        }
      }
      
      // Famille
      if (accountType === 'family' || currentUser.family_pack_id) {
        document.getElementById('card-family').classList.add('active');
        document.getElementById('family-badge').textContent = '‚úì ACTIF';
        document.getElementById('family-badge').classList.remove('inactive');
        document.getElementById('btn-family').textContent = '‚öôÔ∏è G√©rer le Pack Famille';
        document.getElementById('btn-cancel-family').style.display = 'block';
        document.getElementById('family-dates').style.display = 'block';
        
        if (currentUser.family_code || currentUser.pack_code) {
          document.getElementById('family-code-section').style.display = 'block';
          document.getElementById('family-code').textContent = currentUser.family_code || currentUser.pack_code;
        }
        
        if (currentUser.family_start) {
          document.getElementById('family-start').textContent = formatDate(currentUser.family_start);
        }
        
        if (currentUser.family_next) {
          document.getElementById('family-next').textContent = formatDate(currentUser.family_next);
        }
      }
    }
    
    function updateCreditsUI() {
      if (!currentUser) return;
      
      // Cr√©dits vid√©o
      const videoCredits = currentUser.video_credits || 0;
      document.getElementById('video-credits').textContent = videoCredits >= 999999 ? '‚àû' : videoCredits;
      
      // Avatars bonus
      document.getElementById('bonus-avatars').textContent = currentUser.bonus_avatars || 0;
      
      // Avatars mensuels
      const avatarsUsed = currentUser.avatars_used || currentUser.monthly_avatars_used || 0;
      const avatarsLimit = getAvatarLimit(currentUser.account_type);
      
      if (avatarsLimit === Infinity) {
        document.getElementById('monthly-avatars').textContent = `${avatarsUsed} / ‚àû`;
        document.getElementById('progress-avatars').style.width = '0%';
      } else {
        document.getElementById('monthly-avatars').textContent = `${avatarsUsed} / ${avatarsLimit}`;
        const progress = (avatarsUsed / avatarsLimit) * 100;
        document.getElementById('progress-avatars').style.width = `${Math.min(progress, 100)}%`;
      }
    }
    
    function getAvatarLimit(accountType) {
      switch(accountType) {
        case 'subscriber':
        case 'family':
          return 30; // 30 avatars/mois pour Premium et Famille
        case 'admin':
          return Infinity;
        case 'pack':
          return 10;
        default:
          return 2; // Gratuit
      }
    }
    
    // ==========================================
    // TABS
    // ==========================================
    
    function showSection(sectionName, tabElement) {
      // Masquer toutes les sections
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      
      // Afficher la section demand√©e
      document.getElementById(`section-${sectionName}`).classList.add('active');
      tabElement.classList.add('active');
      
      // Charger les donn√©es sp√©cifiques
      if (sectionName === 'history') {
        loadHistory();
      } else if (sectionName === 'avatars') {
        loadAvatars();
      }
    }
    
    // ==========================================
    // TOGGLE PASSWORD
    // ==========================================
    
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
      } else {
        input.type = 'password';
        button.textContent = 'üëÅÔ∏è';
      }
    }
    
    // ==========================================
    // PROFILE
    // ==========================================
    
    async function updateProfile(event) {
      event.preventDefault();
      
      const username = document.getElementById('profile-username').value;
      const token = localStorage.getItem(TOKEN_KEY) || localStorage.getItem('token');
      
      try {
        const response = await fetch('/api/account/update-profile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ username })
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur mise √† jour');
        }
        
        showAlert('alert-profile', '‚úÖ Profil mis √† jour avec succ√®s !', 'success');
        await loadUserData();
        
      } catch (error) {
        console.error('Erreur:', error);
        showAlert('alert-profile', `‚ùå ${error.message}`, 'error');
      }
    }
    
    async function updatePassword(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (newPassword !== confirmPassword) {
        showAlert('alert-password', '‚ùå Les mots de passe ne correspondent pas', 'error');
        return;
      }
      
      if (newPassword.length < 6) {
        showAlert('alert-password', '‚ùå Le mot de passe doit contenir au moins 6 caract√®res', 'error');
        return;
      }
      
      const token = localStorage.getItem(TOKEN_KEY) || localStorage.getItem('token');
      
      try {
        const response = await fetch('/api/account/update-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Mot de passe actuel incorrect');
        }
        
        showAlert('alert-password', '‚úÖ Mot de passe modifi√© avec succ√®s !', 'success');
        document.getElementById('form-password').reset();
        
      } catch (error) {
        console.error('Erreur:', error);
        showAlert('alert-password', `‚ùå ${error.message}`, 'error');
      }
    }
    
    // ==========================================
    // SUBSCRIPTIONS
    // ==========================================
    
    async function managePremium() {
      const accountType = currentUser?.account_type || 'free';
      
      if (accountType === 'subscriber' || accountType === 'admin') {
        openBillingPortal();
      } else {
        await startCheckout('subscription');
      }
    }
    
    async function manageFamily() {
      const accountType = currentUser?.account_type || 'free';
      
      if (accountType === 'family' || currentUser?.family_pack_id) {
        openBillingPortal();
      } else {
        await startCheckout('family');
      }
    }
    
    async function cancelSubscription(type) {
      const typeName = type === 'premium' ? 'Premium' : 'Pack Famille';
      
      if (!confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©silier votre abonnement ${typeName} ?\n\nVotre abonnement restera actif jusqu'√† la fin de la p√©riode en cours.`)) {
        return;
      }
      
      // Rediriger vers le portail Stripe pour la r√©siliation
      openBillingPortal();
    }
    
    async function openBillingPortal() {
      // V√©rifier si l'utilisateur a un compte Stripe associ√©
      if (!currentUser?.stripeCustomerId) {
        alert('‚ÑπÔ∏è Vous n\'avez pas encore de compte de paiement associ√©.\n\nCelui-ci sera cr√©√© automatiquement lors de votre premier achat.');
        return;
      }
      
      const token = localStorage.getItem(TOKEN_KEY) || localStorage.getItem('token');
      
      try {
        const response = await fetch('/api/stripe/create-portal-session', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur portail de paiement');
        }
        
        const { url } = await response.json();
        // Ouvrir dans nouvelle fen√™tre
        window.open(url, '_blank');
        
      } catch (error) {
        console.error('Erreur:', error);
        alert('‚ùå ' + error.message);
      }
    }
    
    // ==========================================
    // PACKS
    // ==========================================
    
    async function buyPack() {
      await startCheckout('pack');
    }
    
    /**
     * D√©marrer un checkout Stripe (m√™me logique que index.html)
     * @param {string} priceType - 'subscription', 'family', ou 'pack'
     */
    async function startCheckout(priceType) {
      if (!currentUser) {
        alert('Erreur: Utilisateur non charg√©. Rechargez la page.');
        return;
      }
      
      try {
        const response = await fetch('/api/stripe/create-checkout-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            priceType: priceType,
            userId: currentUser.id,
            userEmail: currentUser.email
          })
        });
        
        const data = await response.json();
        
        if (data.url) {
          // Ouvrir dans une nouvelle fen√™tre pour ne pas perdre le site
          window.open(data.url, '_blank');
        } else {
          alert('‚ùå ' + (data.error || 'Erreur Stripe'));
        }
        
      } catch (error) {
        console.error('Erreur checkout:', error);
        alert('‚ùå Erreur de connexion');
      }
    }
    
    // ==========================================
    // HISTORY
    // ==========================================
    
    async function loadHistory() {
      const historyContent = document.getElementById('history-content');
      const token = localStorage.getItem(TOKEN_KEY) || localStorage.getItem('token');
      
      try {
        const response = await fetch('/api/account/history', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('Erreur chargement historique');
        
        const data = await response.json();
        
        if (!data.purchases || data.purchases.length === 0) {
          historyContent.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <p>Aucun achat pour le moment</p>
              <p style="margin-top: 0.5rem; font-size: 0.9rem;">Vos futurs achats appara√Ætront ici.</p>
            </div>
          `;
          return;
        }
        
        let html = `
          <div class="table-container">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Produit</th>
                  <th>Montant</th>
                  <th>Statut</th>
                  <th>Facture</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        data.purchases.forEach(purchase => {
          const statusDisplay = (purchase.status === 'paid' || purchase.status === 'Pay√©') 
            ? '‚úÖ Pay√©' 
            : '‚è≥ En attente';
          
          html += `
            <tr>
              <td>${formatDate(purchase.date)}</td>
              <td>${escapeHtml(purchase.product)}</td>
              <td>${escapeHtml(purchase.amount)}</td>
              <td>${statusDisplay}</td>
              <td>
                ${purchase.invoice_url ? `<a href="${purchase.invoice_url}" target="_blank" class="invoice-link">üìÑ T√©l√©charger</a>` : '-'}
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        historyContent.innerHTML = html;
        
      } catch (error) {
        console.error('Erreur:', error);
        historyContent.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <p>Erreur de chargement de l'historique</p>
            <button class="btn btn-secondary btn-small" style="margin-top: 1rem;" onclick="loadHistory()">üîÑ R√©essayer</button>
          </div>
        `;
      }
    }
    
    // ==========================================
    // AVATARS
    // ==========================================
    
    let avatarsLoaded = false;
    
    async function loadAvatars() {
      // √âviter de recharger si d√©j√† charg√©
      if (avatarsLoaded) return;
      
      const gallery = document.getElementById('avatars-gallery');
      const noAvatars = document.getElementById('no-avatars');
      const countBadge = document.getElementById('avatar-count-badge');
      const token = localStorage.getItem(TOKEN_KEY) || localStorage.getItem('token');
      
      try {
        const response = await fetch('/api/avatars/my-avatars', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) throw new Error('Erreur chargement avatars');
        
        const data = await response.json();
        
        if (!data.avatars || data.avatars.length === 0) {
          gallery.style.display = 'none';
          noAvatars.style.display = 'block';
          countBadge.textContent = '0 avatars';
          avatarsLoaded = true;
          return;
        }
        
        // Mettre √† jour le compteur
        countBadge.textContent = `${data.avatars.length} avatar${data.avatars.length > 1 ? 's' : ''}`;
        
        // G√©n√©rer la galerie
        let html = '';
        data.avatars.forEach(avatar => {
          const date = new Date(avatar.created_at).toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: 'short'
          });
          
          html += `
            <div class="avatar-item">
              <span class="avatar-date">${date}</span>
              <img src="${avatar.url}" alt="Avatar" loading="lazy" onerror="this.src='/assets/default-avatar.png'">
              <div class="avatar-actions">
                <button class="avatar-btn avatar-btn-download" onclick="downloadAvatar('${avatar.url}', '${avatar.id}')" title="T√©l√©charger">
                  ‚¨áÔ∏è T√©l√©charger
                </button>
              </div>
            </div>
          `;
        });
        
        gallery.innerHTML = html;
        noAvatars.style.display = 'none';
        avatarsLoaded = true;
        
      } catch (error) {
        console.error('Erreur avatars:', error);
        gallery.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #f44;">
            <p>Erreur de chargement des avatars</p>
            <button class="btn btn-secondary btn-small" style="margin-top: 1rem;" onclick="avatarsLoaded = false; loadAvatars();">üîÑ R√©essayer</button>
          </div>
        `;
      }
    }
    
    function downloadAvatar(url, id) {
      // Cr√©er un lien de t√©l√©chargement
      const link = document.createElement('a');
      link.href = url;
      link.download = `avatar-roronoa-${id || Date.now()}.png`;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // ==========================================
    // AUTH
    // ==========================================
    
    function logout() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(USER_KEY);
      localStorage.removeItem('token');
      window.location.href = '/';
    }
    
    // ==========================================
    // UTILITIES
    // ==========================================
    
    function showAlert(containerId, message, type) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      
      // Scroll vers l'alerte
      container.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
    
    function formatDate(timestamp) {
      if (!timestamp) return '-';
      
      try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return '-';
        
        return date.toLocaleDateString('fr-FR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
      } catch (e) {
        return '-';
      }
    }
    
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ==========================================
    // INIT
    // ==========================================
    
    init();
  </script>
</body>
</html>
